define(["backbone","notifications"],function(t,e){var i=t.Model.extend({url:_s["SYS_CFG.site_uri"]+"organization/"+_s["ORG.organization_id"]+"/setting/",parse:function(){return{}}}),s=t.Model.extend({idAttribute:"user_id",defaults:{is_admin:!1}}),n=t.View.extend({events:{"click .delete":"delete","click .member-detail .common":"switchTranslatePrivilege","click .member-detail .proofread":"switchProofreadPrivilege","click .member-detail .upload":"switchUploadPrivilege","click .member-detail .manage":"switchManagePrivilege"},initialize:function(t){this.organizationUsersView=t.ouv,this.listenTo(this.model,"destroy",function(){this.$el.remove()})},"delete":function(t){t&&t.preventDefault(),this.organizationUsersView.trigger("showRemoveDialog",this)},switchTranslatePrivilege:function(t){t&&t.preventDefault(),this._switchPrivilege("translate",{translate:+!this.model.get("translate")},$(t.target))},switchProofreadPrivilege:function(t){t&&t.preventDefault(),this._switchPrivilege("proofread",{proofread:+!this.model.get("proofread")},$(t.target))},switchUploadPrivilege:function(t){t&&t.preventDefault(),this._switchPrivilege("upload",{upload:+!this.model.get("upload")},$(t.target))},switchManagePrivilege:function(t){t&&t.preventDefault(),this._switchPrivilege("manage",{manage:+!this.model.get("manage")},$(t.target))},switching:!1,_switchPrivilege:function(t,i,s){if(!this.switching){this.switching=!0,s.removeClass("on").addClass("focus");var n=function(){s.removeClass("focus"),this.model.get(t)?s.addClass("on"):s.removeClass("focus")};_.extend(i,{change_prop:t}),this.model.save(i,{context:this,success:function(t,i){this.switching=!1,e.push("已更新成员权限。","success"),n.call(this)},error:function(s,o){this.switching=!1,_s.reqErrorHandle(o,"设置失败：",null,!0,"warning",e);var a=!i[t];i[t]=a,this.model.set(i),n.call(this)}})}},template:_.template($("#template-user").html()),render:function(){return this.template(this.model.attributes)}}),o=t.Collection.extend({model:s,url:_s["SYS_CFG.site_uri"]+"organization/"+_s["ORG.organization_id"]+"/user/"}),a=t.Model.extend({idAttribute:"task_id"}),r=t.Collection.extend({model:a,url:_s["SYS_CFG.site_uri"]+"organization/"+_s["ORG.organization_id"]+"/task/"}),d=t.Model.extend({idAttribute:"comment_id"}),l=t.View.extend({initialize:function(t){this.organizationId=t.organizationId,this.discussionId=t.discussionId},resetElement:function(){this.setElement()},template:_.template($("#template-discussion-comment").html()),render:function(){return this.template(_.extend(this.model.attributes,{parent_user_name:""}))}}),c=t.Collection.extend({model:d,url:function(){return url=_s["SYS_CFG.site_uri"]+"organization/"+this.organizationId,url+="/discussion/"+this.discussionId,url+="/comment/",url},initialize:function(t,e){this.discussionId=e.discussionId,this.organizationId=e.organizationId},parse:function(t){return t.data}}),u=t.View.extend({events:{"keyup .comment-writer":"refreshWriterState","keydown .comment-writer":"clearReplyState","submit .send-comment":"sendComment","click .more-comments":"loadComments","click .comments .comment .reply-comment":"replyComment","click .comments .comment .reply a":"scrollToComment","click .comments .comment .delete-comment":"deleteComment"},resetElement:function(){this.setElement("li.discussion[data-discussion-id="+this.discussionId+"] .comment-outside"),this.$loadCommentsButton=this.$(".more-comments").addClass("hidden"),this.$commentsList=this.$(".comments"),$(".discussions").data("discussion-only")&&this.displayComments("end")},initialize:function(t){this.discussionId=t.discussionId,this.organizationId=t.organizationId,this.commentTotal=t.commentTotal,this.discussionView=t.dv,this.parent=0,this.listenTo(this.collection,"update",function(t){t.each(function(e){if(!this.$("li.comment[data-comment-id="+e.id+"]").length){var i=t.get(e.get("parent_id"));void 0!==i&&e.set({parent_user_name:i.get("user_name")}),this.render(new l({model:e,organizationId:this.organizationId,discussionId:this.discussionId}))}},this)})},displayComments:function(t){this.$commentsList.show(),this.ensureLoadingButton(),this.$commentsList.has("li.comment").length||this._loadComments(t)},loadComments:function(t){this._loadComments(!1),t.preventDefault()},_loadComments:function(t){var t=t?t:20;this.collection.fetch({data:{start:this.collection.size()+1,amount:t},remove:!1,merge:!1,context:this,success:function(t,e,i){this.commentTotal=e.total,this.ensureLoadingButton()}})},hideComments:function(){this.$commentsList.hide(),this.$loadCommentsButton.addClass("hidden")},ensureLoadingButton:function(){return this.commentTotal>this.collection.size()?this.$loadCommentsButton.removeClass("hidden"):void this.$loadCommentsButton.addClass("hidden")},replyComment:function(t){var e=$(t.target),i=e.parents(".comment").data("comment-id"),s=this.collection.get(i),n=e.parents(".comment-outside").find(".comment-writer");return 0===this.parent||this.parent!==s.id?void this._setReply(s,n):void this._unsetReply(n)},_setReply:function(t,e){e.attr("placeholder","回复 "+t.get("user_name")+":"),this.parent=t.id,$("body").scrollTop(e.offset().top-200)},_unsetReply:function(t){t.attr("placeholder","回复此讨论"),this.parent=0},scrollToComment:function(t){t.preventDefault();var e=$(t.target),i=this.$(".comments .comment[data-comment-id="+e.data("parent-id")+"]");i.length&&$("body").scrollTop(i.offset().top-45)},render:function(t){this.$("ul.comments").append(t.render()),t.resetElement()},refreshWriterState:function(t){var e=$(t.target);return e.val().length?(e.height(50),e.siblings(".comment-send").css("display","inline-block")):(e.height(20),void e.siblings(".comment-send").css("display","none"))},clearReplyState:function(t){$target=$(t.target),8===t.keyCode&&""===$target.val()&&this._unsetReply($target)},sendComment:function(t){var i=$(t.target),s=i.find(".comment-writer"),n=i.find(".comment-send");n.attr("disabled","");var o=new d(null,{collection:this.collection});o.set({content:s.val(),parent_id:this.parent,token:_s["APP.token"]});var a=function(e,i,a){var r=i;o.unset("token"),o.set({comment_id:r.comment_id,user_name:_s["USER.name"],friendly_time:"不久之前"}),this.discussionView.commentsExpanded||this.discussionView.expandComments(t);var d=this.discussionView.model.get("comment_total");this.discussionView.model.set({comment_total:++d}),this._loadComments("end"),s.val(""),n.removeAttr("disabled"),r.token&&(_s["APP.token"]=r.token)},r=function(t,i,s){var o=i.responseJSON;e.push(o.status_detail,"warning"),n.removeAttr("disabled"),o.token&&(_s["APP.token"]=o.token)};o.save(null,{success:a,error:r,context:this}),t.preventDefault()},deleteComment:function(t){t&&t.preventDefault();var i=$(t.target),s=i.parents(".comment").data("comment-id"),n=this.collection.get(s);i.attr("disabled",!0).text("正在删除···"),n.destroy({context:this,success:function(t,e){e&&"comment_deleted"!==!e.status_short&&(i.parents(".comment").remove(),this.discussionView.model.set({comment_total:this.discussionView.model.get("comment_total")-1}))},error:function(t,i){_s.reqErrorHandle(i,"删除失败：",null,!0,"warning",e)}})}}),m=t.Model.extend({idAttribute:"discussion_id"}),h=t.View.extend({events:{"click .delete-this":"removeDiscussion","click .expand-comments":"expandComments"},template:_.template($("#template-discussion").html()),resetElement:function(){this.setElement("li.discussion[data-discussion-id="+this.model.id+"]"),this.$expandCommentsButton=this.$(".expand-comments"),this.commentsExpanded=!1,this._refreshExpandCommentsButtonState(this.commentsView.collection),this.commentsView.resetElement()},expandComments:function(t){return this.commentsExpanded?(this.commentsView.hideComments(),this.$expandCommentsButton.text(this.model.get("comment_total")+"条回复"),void(this.commentsExpanded=!1)):(this.commentsView.displayComments(),this.$expandCommentsButton.css("display","inline-block").text("收起所有"),void(this.commentsExpanded=!0))},removeDiscussion:function(t){t&&t.preventDefault(),this.discussionView.deleteDiscussionDialog.setView(this).$el.removeClass("hidden")},initialize:function(t){var e={discussionId:this.model.id,organizationId:t.organizationId,commentTotal:this.model.get("comment_total"),dv:this};this.discussionView=t.dv,this.commentsView=new u(_.extend({collection:new c(null,e)},e)),this.listenTo(this.commentsView.collection,"update",this._refreshExpandCommentsButtonState)},_refreshExpandCommentsButtonState:function(){return this.model.get("comment_total")>0?void this.$expandCommentsButton.css("display","inline-block"):void 0},render:function(){return this.template({discussion_id:this.model.id,organization_id:this.model.get("organization_id"),avatar_link:this.model.get("avatar_link"),user_id:this.model.get("user_id"),user_name:this.model.get("user_name"),content:_.escape(this.model.get("content")).replace(/\n/g,"<br>"),friendly_time:this.model.get("friendly_time"),can_delete:this.model.get("can_delete"),comment_total:this.model.get("comment_total")})}}),g=t.Collection.extend({model:m,url:function(){return _s["SYS_CFG.site_uri"]+"organization/"+this.organizationId+"/discussion/"},initialize:function(t,e){this.organizationId=e.organizationId,this.discussionTotal=e.discussionTotal},parse:function(t,e){return t.data}}),f=t.View.extend({el:".dialog-delete-discussion",events:{"click .delete":"delete","click .cancel":"cancel"},setView:function(t){return this.view=t,this},"delete":function(t){t&&t.preventDefault();this.view;$(t.target).attr("disabled",!0).text("正在删除···"),this.view.model.destroy({context:this,success:function(e,i){i&&"discussion_deleted"===i.status_short&&($(t.target).text("删除完成"),location.href=_s["SYS_CFG.site_url"]+"organization/"+_s["ORG.organization_id"])},error:function(i,s){_s.reqErrorHandle(s,"删除失败：",null,!0,"warning",e),$(t.target).removeAttr("disabled").text("删除")}})},cancel:function(t){t&&t.preventDefault(),this.$el.addClass("hidden")}}),p=t.View.extend({el:".organization-discussion",events:{"submit .send-discuss":"newDiscussion","keyup .discuss-input":"refreshInputCharLength","click .more-discussions":"moreDiscussions"},initialize:function(t){this.$newDiscussion=this.$(".send-discuss"),this.$disInput=this.$(".discuss-input"),this.$disCharCount=this.$(".char-count .current"),this.$disSend=this.$(".action .discuss-send"),this.$disSend.attr("disabled",""),this.$discussions=this.$("ul.discussions"),this.organizationId=t.organizationId,this.discussionTotal=t.discussionTotal,this.deleteDiscussionDialog=new f,this.collection=new g(null,{organizationId:this.organizationId,discussionTotal:this.discussionTotal}),this.listenTo(this.collection,"reset",function(t){t.each(function(t){new h({model:t,organizationId:this.organizationId,dv:this}).resetElement()},this),this._moreDiscussionsButtonRefresh(this.discussionTotal)}),this.listenTo(this.collection,"sync",function(t){t.each(function(t){this.$discussions.find("li.discussion[data-discussion-id="+t.id+"]").length||this.render(new h({model:t,organizationId:this.organizationId,dv:this}))},this),this._moreDiscussionsButtonRefresh(this.discussionTotal)},this),this.collection.reset(_s["ORG.discussions"]),this._moreDiscussionsButtonRefresh(this.discussionTotal)},_moreDiscussionsButtonRefresh:function(t){var e=$(".more-discussions");return this.collection.size()>=t?void e.hide():void e.show()},render:function(t){this.$discussions.append(t.render()),t.resetElement()},refreshInputCharLength:function(t){var e=$(t.target).val().length;e>500?(this.$disCharCount.addClass("exceed"),this.$disSend.attr("disabled","")):e>=1&&500>=e?(this.$disCharCount.removeClass("exceed"),this.$disSend.removeAttr("disabled")):this.$disSend.attr("disabled",""),$(".char-count .current").text(e),t.preventDefault()},newDiscussion:function(t){this.$disSend.attr("disabled",""),this.$disSend.text("正在发表···");var i=new m(null,{collection:this.collection});i.set({content:this.$disInput.val(),token:_s["APP.token"]});var s=this,n=function(t,e,i){window.location.reload()},o=function(t,i,n){var o=i.responseJSON;""!==o.status_detail?e.push(o.status_detail,"warning"):"",o.token&&(_s["APP.token"]=o.token),s.$disSend.removeAttr("disabled"),s.$disSend.text("发表")};i.save(null,{success:n,error:o}),t.preventDefault()},moreDiscussions:function(t){var e=20;this.collection.fetch({data:{start:this.collection.size()+1,amount:e},remove:!1,merge:!1,success:function(t,e,i){this.discussionTotal=e.total},context:this});t.preventDefault()}}),v=t.View.extend({el:".dialog-exit-organization",events:{"click .exit":"exit","click .cancel":"cancel"},exit:function(t){t&&t.preventDefault();var i=$(t.target);i.attr("disabled",!0).text("正在退出···"),$.ajax(_s["SYS_CFG.site_uri"]+"organization/"+_s["ORG.organization_id"]+"/user/exit/",{method:"DELETE",dataType:"json",context:this,success:function(t){t&&"user_exited"===t.status_short&&(i.text("已退出"),location.href=_s["SYS_CFG.site_url"]+"start")},error:function(t){_s.reqErrorHandle(t,"请求退出失败：",null,!0,"warning",e),i.text("退出").removeAttr("disabled")}})},cancel:function(t){t&&t.preventDefault(),this.$el.addClass("hidden")}}),w=t.View.extend({el:"body",events:{"click .join-organization":"joinOrganization","click .exit-organization":"showExitDialog"},initialize:function(){this.$orgDetail=this.$(".organization-left"),this.$sendDiscussionArea=this.$(".send-discuss"),this.$sendDiscussTextarea=this.$sendDiscussionArea.find(".discuss-input"),this.$commentWriter=this.$(".comment-writer"),this.$joinButton=this.$(".join-organization"),this.organizationId=_s["ORG.organization_id"],this.discussionTotal=_s["ORG.discussion_total"],this.exitOrganizationDialog=new v,_s["USER.is_login"]||(this.$sendDiscussionArea.css("display","none"),this.$joinButton.attr("disabled","").text("登录以加入此组织")),_s["USER.is_member_of_org"]||_s["USER.is_admin"]||(this.$sendDiscussTextarea.attr("disabled",""),this.$sendDiscussTextarea.attr("placeholder","加入组织以参与讨论"),$(".send-comment .comment-writer").css("display","none")),1===_s["ORG.page_type"]&&(this.discussionsView=new p({organizationId:this.organizationId,discussionTotal:this.discussionTotal}),this.$(".discussions").data("discussion-only")&&this.$(".more-discussions").hide())},joinOrganization:function(t){t&&t.preventDefault(),$target=$(t.target),$.ajax(_s["SYS_CFG.site_uri"]+"organization/"+_s["ORG.organization_id"]+"/user/join/",{method:"POST",dataType:"json",data:{token:_s["APP.token"]},context:this,beforeSend:function(){$target.text("正在请求···").attr("disabled",!0)},success:function(t){t&&"join_organization_request_sended"===t.status_short&&t.token?($target.text("已发送加入请求"),_s["APP.token"]=t.token):t&&"join_organization_succeed"===t.status_short&&(location.href=_s["SYS_CFG.site_url"]+"organization/"+_s["ORG.organization_id"])},error:function(t){_s.reqErrorHandle(t,"请求失败：",null,!0,"warning",e),$target.text("加入").removeAttr("disabled"),_s["APP.token"]=t.token}})},showExitDialog:function(t){t&&t.preventDefault(),this.exitOrganizationDialog.$el.removeClass("hidden")}}),z=t.View.extend({el:".organization-tasks",events:{"click .page-forward":"loadTasks"},initialize:function(){this.collection=new r(_s["ORG.tasks"],{otv:this})},loadTasks:function(t){t&&t.preventDefault(),this.collection.size()>=_s["ORG.member"]||this.collection.fetch({context:this,data:{start:this.collection.size()+1,amount:20},remove:!1,merge:!1,success:function(t,e){this.render(),this.toggleButtonState()},error:function(t,e){var e=e.responseJSON;"tasks_not_found"===e.status_short&&(_s["ORG.task_total"]=this.collection.size(),this.toggleButtonState())}})},template:_.template($("#template-task").html()),render:function(){this.collection.each(function(t){this.$(".task-summary[data-task-id="+t.id+"]").length||this.$("tbody").append(this.template(t.attributes))},this)},toggleButtonState:function(){return this.collection.size()>=_s["ORG.task_total"]?this.$("tfoot").addClass("hidden"):this.$("tfoot").removeClass("hidden")}}),x=t.View.extend({el:".delete-user",events:{"click .delete":"delete","click .close":"hide"},user:void 0,initialize:function(t){this.organizationUsersView=t.ouv},"delete":function(t){t&&t.preventDefault();var i=$(t.target);i.attr("disabled",!0),this.user.destroy({context:this,success:function(t,i){this.hide(void 0),e.push("已移除该成员。","success")},error:function(t,i){_s.reqErrorHandle(i,"删除失败：",null,!0,"warning",e),this.hide(void 0),this.user=void 0}})},show:function(t,e){t&&t.preventDefault(),this.userView=e,this.user=e.model,this.$(".name").text(this.user.get("user_name")),this.$(".delete").attr("disabled",!1),this.$el.removeClass("hidden")},hide:function(t){t&&t.preventDefault(),this.$el.addClass("hidden")}}),k=t.View.extend({el:".organization-members",events:{"click .page-forward":"loadUsers"},initialize:function(){this.collection=new o(_s["ORG.users"],{ouv:this}),this.deleteUserDialog=new x({ouv:this}),this.on("showRemoveDialog",function(t){this.deleteUserDialog.show(void 0,t)},this),this.collection.each(function(t){new n({model:t,ouv:this}).setElement(this.$("tbody tr[data-user-id="+t.id+"]"))},this)},loadUsers:function(t){t&&t.preventDefault(),this.collection.size()>=_s["ORG.member_total"]||this.collection.fetch({context:this,data:{start:this.collection.size()+1,amount:20},remove:!1,merge:!1,success:function(t,e){this.render(),this.toggleButtonState()},error:function(t,e){var e=e.responseJSON;"users_not_found"===e.status_short&&(_s["ORG.member_total"]=this.collection.size(),this.toggleButtonState())}})},render:function(){this.collection.each(function(t){if(!this.$("tbody [data-user-id="+t.id+"]").length){var e=new n({ouv:this,model:t});this.$("tbody").append(e.render()),e.setElement(this.$("tbody [data-user-id="+t.id+"]"))}},this)},toggleButtonState:function(){return this.collection.size()>=_s["ORG.member_total"]?this.$("tfoot").addClass("hidden"):this.$("tfoot").removeClass("hidden")}}),C=t.View.extend({el:".organization-right",events:{"submit .organization-settings":"saveSettings"},initialize:function(){this.settings=new i({name:_s["ORG.name"],description:_s["ORG.description"],maximum:_s["ORG.maximum"],join_mode:_s["ORG.join_mode"],accessibility:_s["ORG.accessibility"],default_privileges:_s["ORG.default_privileges"],member_create_task:_s["ORG.member_create_task"]},{osv:this})},saveSettings:function(t){t.preventDefault();var i=$(t.target);i.find("button[type=submit]").attr("disabled",!0);var s=0;this.$("input[name=organization-default-privileges-translate]").is(":checked")&&(s=1),this.$("input[name=organization-default-privileges-proofread]").is(":checked")&&(s=2),this.$("input[name=organization-default-privileges-translate]").is(":checked")&&this.$("input[name=organization-default-privileges-proofread]").is(":checked")&&(s=3),this.settings.set({token:_s["APP.token"],name:this.$("#organization-name").val(),description:this.$("#organization-desc").val(),maximum:+this.$("input[name=organization-member-limit]").filter(":checked").val(),join_mode:this.$("input[name=organization-join-mode]").filter(":checked").val(),accessibility:this.$("input[name=organization-accessibility]").is(":checked"),default_privileges:s,member_create_task:this.$("input[name=organization-create-task]").is(":checked")}),this.settings.save(null,{success:function(t,s){i.find("button[type=submit]").removeAttr("disabled"),"settings_saved"===s.status_short&&(e.push("已保存。","success"),_s["APP.token"]=s.token,$("title").text(t.get("name")+" / 组织成员 / ResTrans"),$(".organization-left a.organization-name").text(t.get("name")),$(".organization-left p.organization-description").html(_s.xescape(t.get("description"))))},error:function(t,s){i.find("button[type=submit]").removeAttr("disabled"),_s.reqErrorHandle(s,"保存失败：",null,!0,"warning",e)}})}});new w,2===_s["ORG.page_type"]&&new z,3===_s["ORG.page_type"]&&new k,4===_s["ORG.page_type"]&&new C});