define(["backbone","notifications"],function(e,s){var t=e.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"message/receiver",idAttribute:"user_id"}),i=e.View.extend({initialize:function(e){this.setElement(e.$msgvEl.find(".write-message")),this.$receiverAvatar=this.$(".receiver"),this.$searchInput=this.$(".search-receiver-keyword"),this.$showSearchInput=this.$(".show-search-input"),this.model?null:this.model=new t,this.listenTo(this.model,"change",function(e){return this._ensureState(),e.has("user_id")&&e.has("name")&&e.has("avatar_link")?(this.$receiverAvatar.find(".username").html(e.escape("name")),this.$receiverAvatar.find("img").attr("src",e.get("avatar_link")),this.$receiverAvatar.css({display:"inline-block"}),void this.$searchInput.hide()):(this.$receiverAvatar.hide(),void this.$searchInput.show())}),this._ensureState()},_ensureState:function(){this.model.id?this.$showSearchInput.show():this.$showSearchInput.hide()},events:{"submit .search-area":"searchReceiver","click .show-search-input":"resetState"},resetState:function(e){e.preventDefault(),this.model.clear()},searchReceiver:function(e){e.preventDefault();var s=this.model,t=($(e.target),this.$searchInput.val());s.clear(),s.fetch({data:{keyword:t},context:this,success:function(){this.$searchInput.val("")}})}}),n=e.Model.extend({idAttribute:"message_id",validate:function(e){return e.receiver?!e.content||!e.content.length||e.content.length>1e3?"私信内容必须介乎 1-1000 字符之间。":void 0:"请输入私信接受方的 ID 或 用户名。"}}),o=e.Collection.extend({model:n,url:function(){return _s["SYS_CFG.site_uri"]+"message/"+this.conversationModel.get("owner")+"/"+this.conversationModel.get("otherside")},initialize:function(e,s){this.conversationModel=s.conversationModel}}),a=e.View.extend({events:{"click .msg-options .delete":"deleteMessage"},resetElement:function(){this.setElement(this.$diag.find(".message[data-message-id="+this.model.id+"]"))},initialize:function(e){this.$diag=e.$diag,this.messageDeleteConfirm=!1},ensureTemplate:function(){this.template=this.model.get("type")?_.template($("#template-myself").html()):_.template($("#template-otherside").html())},render:function(){this.ensureTemplate();var e=this.model.get("type"),s=!(e||!this.model.get("unread"));return this.template({message_id:this.model.id,name:e?this.model.get("owner_name"):this.model.get("otherside_name"),owner:this.model.get("owner"),otherside:this.model.get("otherside"),owner_avatar_link:this.model.get("owner_avatar_link"),otherside_avatar_link:this.model.get("otherside_avatar_link"),content:this.model.get("content"),friendly_time:this.model.get("friendly_time"),unread:s})},messageDeleteConfirm:!1,deleteMessage:function(e){e.preventDefault();var t=$(e.target);return this.messageDeleteConfirm?void this.model.destroy({success:function(){this.remove()},error:function(e,t){var t=t.responseJSON;s.push(t.status_detail,"warning")},context:this}):(t.text("再按一次以删除"),void(this.messageDeleteConfirm=!0))}}),r=e.View.extend({events:{"click .more-messages a":"moreMessages"},initialize:function(e){this.conversationModel=e.conversationModel,this.collection=new o(null,{conversationModel:e.conversationModel}),this.on("resetNewMessages",function(e){this.insertMessages(e),this._scroll()},this),this.on("setNewMessages",function(e){this.insertMessages(e)},this),this.on("setMessagesAsRead",function(){$.post(_s["SYS_CFG.site_uri"]+"message/"+this.conversationModel.get("owner")+"/"+this.conversationModel.get("otherside")+"/readed/","","","json")},this)},_scroll:function(){var e=this.$(".diag-messages");e.scrollTop(this.$(".diag-messages").height())},insertMessages:function(e){var s=this.$(".more-messages"),t=this.$(".diag-messages");e.each(function(e){if(!t.find(".message[data-message-id="+e.id+"]").length){var i=new a({model:e,$diag:t});s.after(i.render()),i.resetElement()}},this)},viewMessages:function(e){this._clearMessages(),this.collection.length?this.insertMessages(this.collection):this.resetNewMessages(),e&&this.trigger("setMessagesAsRead")},_clearMessages:function(){var e=this.$(".diag-messages");e.remove(".message")},resetNewMessages:function(){this._switchMoreMessagesActionState("loading"),this.collection.fetch({data:{start:1,amount:this.reqAmount},reset:!0,context:this,success:function(e,s){this.trigger("resetNewMessages",e),s.length<this.reqAmount&&this._switchMoreMessagesActionState("no_messages"),this._switchMoreMessagesActionState("load")},error:function(){this._switchMoreMessagesActionState("no_messages")}})},reqAmount:20,setNewMessages:function(e){this._switchMoreMessagesActionState("loading");var e=(e?e:this.collection.size())+20;this.collection.fetch({data:{start:e,amount:this.reqAmount},remove:!1,merge:!1,context:this,success:function(e,s){this.trigger("setNewMessages",e),s.length<this.reqAmount&&this._switchMoreMessagesActionState("no_messages"),this._switchMoreMessagesActionState("load")},error:function(){this._switchMoreMessagesActionState("no_messages")}})},_switchMoreMessagesActionState:function(e){var s=this.$(".more-messages");"load"===e?s.html('<a href="">加载更早的私信</a>'):"loading"===e?s.html('<span><i class="loading"></i>正在加载</a>'):"no_messages"===e&&s.html("<span>没有更多私信</a>")},moreMessages:function(e){e.preventDefault(),this.setNewMessages()},render:function(){var e=_.template($("#template-dialogue").html());return this.between=this.conversationModel.get("owner")+"-"+this.conversationModel.get("otherside"),e({between:this.between})},createDialogue:function(){$(".message-dialog .dialog-body").append(this.render()),this.setElement(".message-dialog .dialog-body .dialogue[data-conversation-between="+this.between+"]")},replyMessage:function(e){var t=this.$(".message-writer .content-input"),i=new c({receiver:this.conversationModel.get("otherside"),content:t.val(),token:_s["APP.token"]},{validate:!0}),n=$(e.target),o=function(){n.html("回复")};if(n.html('<i class="loading"></i>正在回复'),i.validationError)return o(),void s.push(i.validationError,"warning");var a=function(e,s){o(),s.token&&(_s["APP.token"]=s.token),e.unset("token"),e.unset("receiver"),e.set({message_id:s.message_id,owner:this.conversationModel.get("owner"),owner_avatar_link:s.avatar_link,otherside:this.conversationModel.get("otherside"),type:1,owner_name:this.conversationModel.get("owner_name"),otherside_name:this.conversationModel.get("otherside_name"),unread:1,friendly_time:"不久之前"},{silent:!0}),this.collection.add(e),this.addMessage(e),t.val("")},r=function(e,t){var t=t.responseJSON;t.token&&(_s["APP.token"]=t.token),o(),s.push(t.status_detail,"warning")};i.save(null,{success:a,error:r,context:this})},addMessage:function(e){var s=this.$(".diag-messages"),t=new a({model:e,$diag:s});s.append(t.render()),t.resetElement()}}),h=e.View.extend({template:_.template($("#template-conversation").html()),events:{"click .conversation-view-all":"viewMessages","click .conversation-delete":"deleteConversation"},dialogueMessagesView:!1,viewMessages:function(e){this.dialogueMessagesView||(this.dialogueMessagesView=new r({conversationModel:this.model})),this.dialogueMessagesView.createDialogue(),this.dialogueMessagesView.viewMessages(this.model.get("unread")),this.messageDialogView.viewMessages(this.model,this.dialogueMessagesView),this.model.set({unread:!1},{silent:!0}),this.conversationsView.setMessageReaded(this.model.id)},deleteConversation:function(e){e.preventDefault(),this.model.url=_s["SYS_CFG.site_uri"]+"conversation/otherside/"+this.model.get("otherside"),this.model.destroy({success:function(){this.remove()},context:this})},initialize:function(e){this.messageDialogView=e.messageDialogView,this.conversationsView=e.conversationsView},resetElement:function(){this.setElement(".conversation[data-message-id="+this.model.id+"]")},render:function(){var e=this.model.get("otherside"),s=this.model.get("otherside_name");return this.template({message_id:this.model.id,otherside_id:e,otherside_name:s,avatar_link:this.model.get("avatar_link"),time:this.model.get("friendly_time"),content:this.model.get("content"),unread:this.model.get("unread")})}}),l=e.Collection.extend({model:n,url:_s["SYS_CFG.site_uri"]+"conversation/",comparator:function(e,s){return s.id-e.id}}),d=e.View.extend({el:".message-dialog .dialog-body .conversations",events:{"click .more-conversations":"loadConversations"},initialize:function(e){this.messageDialogView=e.messageDialogView,this.$loadingConversations=this.$(".loading-conversations"),this.$moreConversations=this.$(".more-conversations"),this.on("resetConversations",function(e){this.$loadingConversations.hide(),this.insertConversations(e),this._switchMoreConversationsAction("load"),e.length>=this.reqAmount?this.$moreConversations.removeClass("hidden"):this.$moreConversations.addClass("hidden")},this),this.on("setConversations",function(e){this.insertConversations(e),this._switchMoreConversationsAction("load")},this)},loadConversations:function(e){e.preventDefault(),$target=$(e.target),this._switchMoreConversationsAction("loading"),this.fetchNewConversations()},_switchMoreConversationsAction:function(e){"loading"===e?(this.$moreConversations.find("a").css({display:"none"}),this.$moreConversations.find("i").css({display:"inline-block"})):"load"===e&&(this.$moreConversations.find("a").css({display:"block"}),this.$moreConversations.find("i").css({display:"none"}))},insertConversations:function(e){e.each(function(s){models=e.where({otherside:s.get("otherside")}),models.length&&$(".conversation[data-message-id="+models[0].id+"]").remove();var t=new h({model:s,messageDialogView:this.messageDialogView,conversationsView:this});this.$moreConversations.before(t.render()),t.resetElement()},this)},reqAmount:20,fetching:!1,resetNewConversations:function(){this.fetching=!0,this.$(".conversation").remove(),this.$loadingConversations.show(),this.collection.fetch({data:{start:1,amount:this.reqAmount},reset:!0,context:this,success:function(e){this.trigger("resetConversations",e),this.fetching=!1},error:function(){this.fetching=!1,this.$loadingConversations.hide(),s.push("没有找到任何会话。"),this.messageDialogView.displayMessageWriterDialog()}})},fetchNewConversations:function(e){this.fetching=!0;var e=(e?e:this.collection.size())+20;this.collection.fetch({data:{start:e,amount:this.reqAmount},remove:!1,merge:!1,context:this,success:function(e,s){this.trigger("setConversations",e),this.fetching=!1},error:function(){this.fetching=!1,this.$moreConversations.hide()}})},setMessageReaded:function(e){this.$(".conversation[data-message-id="+e+"] .unread").html("")}}),c=n.extend({urlRoot:_s["SYS_CFG.site_uri"]+"message/"}),g=e.View.extend({el:".message-dialog .dialog-body .write-message",initialize:function(e){this.receiverView=e.receiverView,this.messageDialogView=e.messageDialogView},_resetSendMessageButton:function(e){e.removeAttr("disabled"),e.find("i.loading").remove()},sendMessage:function(e){var t=$(e.target);t.attr("disabled",""),t.prepend('<i class="loading"></i>');var i=new c({receiver:this.receiverView.model.id,content:this.$(".content-input").val(),token:_s["APP.token"]},{validate:!0});if(i.validationError)return this._resetSendMessageButton(t),void s.push(i.validationError,"warning");var n=function(s,i,n){i.token&&(_s["APP.token"]=i.token),this.receiverView.model.clear(),this.messageDialogView.refreshMessages(e),this.messageDialogView.displayConversationsDialog(e),this.$(".content .content-input").val(""),this._resetSendMessageButton(t)},o=function(e,i,n){i.responseJSON.token&&(_s["APP.token"]=i.responseJSON.token),_s.reqErrorHandle(i,"发送私信失败：",null,!0,"warning",s),this._resetSendMessageButton(t)};i.save(null,{success:n,error:o,context:this})}});return MessageDialogView=e.View.extend({el:".message-dialog",events:{"click .msg-diag-allcnv":"displayConversationsDialog","click .msg-diag-newmsg":"displayMessageWriterDialog","change .search-area":"searchReceiver","click .send-message":"sendMessage","click .close-message-dialog":"closeMessageDialog","click .refresh-messages":"refreshMessages","click .reply-message":"replyMessage"},initialize:function(){this.$conversations=this.$(".conversations"),this.$headerConversations=this.$(".msg-diag-allcnv"),this.$newMessage=this.$(".write-message"),this.$headerNewMessage=this.$(".msg-diag-newmsg"),this.$messageDialogue=this.$(".dialogue"),this.$headerMessageDialogue=this.$(".msg-diag-dialogue"),this.$refreshMessages=this.$(".refresh-messages"),this.$buttonReplyMessage=this.$(".reply-message"),this.$buttonSendMessage=this.$(".send-message"),this.conversationsCollection=new l,this.conversationsView=new d({collection:this.conversationsCollection,messageDialogView:this})},_activeDiagBody:function(e){_.forIn(this.bodyList,function(s,t){e===t?this[s].removeClass("hidden"):this[s].addClass("hidden")},this)},bodyList:{conversations:"$conversations",writer:"$newMessage"},_deactiveAllDiagBody:function(){_.each(this.bodyList,function(e){this[e].addClass("hidden")},this)},_activeHeader:function(e,s){var t={all:"$headerConversations","new":"$headerNewMessage",dialogue:"$headerMessageDialogue"};_.forIn(t,function(s,t){e===t?this[s].addClass("active"):this[s].removeClass("active")},this),"dialogue"===e&&this[t[e]].find("a").text(s),"dialogue"!==e?this[t.dialogue].hide():this[t.dialogue].show()},refreshMessages:function(e){e.preventDefault(),this.conversationsView.fetching||this.conversationsView.resetNewConversations()},clearDialogue:function(){this.$(".dialogue").remove()},displayConversationsDialog:function(e){e.preventDefault(),this.$el.show(),this.newConversationsFetched&&!this.conversationsCollection.length&&s.push("没有会话。"),this._activeDiagBody("conversations"),this._activeHeader("all"),this.clearDialogue(),this.$buttonReplyMessage.hide(),this.$buttonSendMessage.hide(),this.$refreshMessages.show(),this.newConversationsFetched||this.conversationsView.resetNewConversations(),this.newConversationsFetched=!0},newConversationsFetched:!1,displayMessageWriterDialog:function(e){e&&e.preventDefault(),this.$el.show(),this._activeDiagBody("writer"),this._activeHeader("new"),this.clearDialogue(),this.$buttonReplyMessage.hide(),this.$buttonSendMessage.show(),this.$refreshMessages.hide(),this.receiverView?null:this.receiverView=new i({$msgvEl:this.$el}),this.newMessageView||(this.newMessageView=new g({receiverView:this.receiverView,messageDialogView:this}))},viewMessages:function(e,s){this.$el.show(),this._deactiveAllDiagBody();var t=e.get("owner")+"-"+e.get("otherside");this.$(".dialog-body .dialogue[data-conversation-between="+t+"]").show(),this._activeHeader("dialogue",e.get("otherside_name")),this.$buttonReplyMessage.show(),this.$buttonSendMessage.hide(),this.$refreshMessages.hide(),this.dialogueMessagesView=s},sendMessage:function(e){e.preventDefault(),this.newMessageView.sendMessage(e)},closeMessageDialog:function(e){this.$el.hide()},replyMessage:function(e){e.preventDefault(),this.dialogueMessagesView.replyMessage(e)}}),MessageDialogView});