define(["backbone","notifications"],function(t,e){var s=t.Model.extend({defaults:{token:_s["APP.token"]},urlRoot:_s["SYS_CFG.site_uri"]+"user/login/",validate:function(t,e){return""===t.userident?"userident_is_empty":""===t.password?"password_is_empty":void 0}}),n=t.Model.extend({defaults:{token:_s["APP.token"]},urlRoot:_s["SYS_CFG.site_uri"]+"user/register/",validate:function(t,e){return""===t.username?"username_is_empty":""===t.password?"password_is_empty":void 0}}),i=t.Model.extend({defaults:{token:_s["APP.token"]},urlRoot:_s["SYS_CFG.site_uri"]+"user/retrieve/",validate:function(t,e){return""===t.useremail?"useremail_is_empty":void 0}}),a=t.Model.extend({defaults:{token:_s["APP.token"]},urlRoot:_s["SYS_CFG.site_uri"]+"user/password/reset/"}),r=t.View.extend({el:"body",_changeButtonState:function(t,e,s){e?t.attr("disabled","disabled"):t.removeAttr("disabled"),t.html(s)},changeCaptcha:function(t){$("img.captcha").attr("src",_s["SYS_CFG.site_uri"]+"captcha?"+Math.random()),t.preventDefault()}}),o=r.extend({events:{"submit form#login-form":"login","click #change-captcha":"changeCaptcha"},initialize:function(){this.$userIdentInput=this.$el.find("#login-user-ident"),this.$passwordInput=this.$el.find("#login-password"),this.$captchaInput=this.$el.find("#login-captcha"),this.$loginActionButton=this.$el.find("#login-action")},login:function(t){this._changeButtonState(this.$loginActionButton,!0,"正在登录···"),this.model.set({userident:this.$userIdentInput.val(),password:this.$passwordInput.val(),captcha:this.$captchaInput.val()}),this.listenToOnce(this.model,"invalid",function(){"userident_is_empty"===this.model.validationError?this.$userIdentInput.addClass("re-input-error"):this.$userIdentInput.removeClass("re-input-error"),"password_is_empty"===this.model.validationError?this.$passwordInput.addClass("re-input-error"):this.$passwordInput.removeClass("re-input-error"),this._changeButtonState(this.$loginActionButton,!1,'登录<i class="right"></i>')});var s=this,n=function(t,e,n){"login_successful"===e.status_short&&(s._changeButtonState(s.$loginActionButton,!0,"请稍候···"),location.href=_s["HOME.redirect"]?decodeURIComponent(_s["HOME.redirect"]):_s["SYS_CFG.site_url"]+"start"),"login_successful_verify_email"===e.status_short&&(s._changeButtonState(s.$loginActionButton,!0,"需要完善一些信息···"),location.href=_s["SYS_CFG.site_url"]+"user/email/resend/")},i=function(t,n,i){var a=n.responseJSON;""!==a.status_detail?e.push(a.status_detail,"warning"):"",a.token&&(s.model.set({token:a.token}),_s["APP.token"]=a.token),$("img.captcha").attr("src",_s["SYS_CFG.site_uri"]+"captcha?"+Math.random()),s._changeButtonState(s.$loginActionButton,!1,'登录<i class="right"></i>')};this.model.save(null,{success:n,error:i}),t.preventDefault()}}),u=r.extend({events:{"submit form#register-form":"register","click #show-password":"showPassword","click #change-captcha":"changeCaptcha"},initialize:function(){this.$usernameInput=this.$el.find("#register-username"),this.$emailInput=this.$el.find("#register-email"),this.$passwordInput=this.$el.find("#register-password"),this.$captchaInput=this.$el.find("#register-captcha"),this.$registerActionButton=this.$el.find("#register-action"),this.$showPasswordAction=this.$el.find("#show-password")},showPassword:function(t){t.preventDefault();var e=this.$passwordInput.attr("type");return"password"===e?(this.$passwordInput.attr("type","text"),void this.$showPasswordAction.text("藏")):(this.$showPasswordAction.text("显"),void this.$passwordInput.attr("type","password"))},register:function(t){this._changeButtonState(this.$registerActionButton,!0,"正在注册···");var s={username:this.$usernameInput.val(),password:this.$passwordInput.val(),captcha:this.$captchaInput.val()};1===+this.$emailInput.length&&(s.useremail=this.$emailInput.val()),this.model.set(s),this.listenToOnce(this.model,"invalid",function(){"username_is_empty"===this.model.validationError?this.$usernameInput.addClass("re-input-error"):this.$usernameInput.removeClass("re-input-error"),"password_is_empty"===this.model.validationError?this.$passwordInput.addClass("re-input-error"):this.$passwordInput.removeClass("re-input-error"),this._changeButtonState(this.$registerActionButton,!1,"注册")});var n=this,i=function(t,e,s){n._changeButtonState(n.$registerActionButton,!0,e.status_detail),n.$emailInput.parent("label").hide(),n.$passwordInput.parent("label").hide(),n.$captchaInput.parent("label").hide(),n.$usernameInput.siblings("span").text("使用此用户名登录"),n.$usernameInput.attr("disabled","disabled")},a=function(t,s,i){var a=s.responseJSON,r=["invalid_username","invalid_password","invalid_email","username_unable_to_use","email_unable_to_use","unknown_error_occurred","invalid_captcha","token_auth_failed"];-1!==_.indexOf(r,a.status_short)&&e.push(a.status_detail,"warning"),a.token&&(n.model.set({token:a.token}),_s["APP.token"]=a.token),$("img.captcha").attr("src",_s["SYS_CFG.site_uri"]+"captcha?"+Math.random()),n._changeButtonState(n.$registerActionButton,!1,"注册")};this.model.save(null,{success:i,error:a}),t.preventDefault()}}),l=r.extend({events:{"submit form#retrieve-form":"retrieve","click #change-captcha":"changeCaptcha"},initialize:function(){this.$emailInput=this.$el.find("#retrieve-email"),this.$captchaInput=this.$el.find("#retrieve-captcha"),this.$retrieveActionButton=this.$el.find("#retrieve-action")},retrieve:function(t){t.preventDefault(),this._changeButtonState(this.$retrieveActionButton,!0,"请求发送邮件···"),this.model.set({useremail:this.$emailInput.val(),captcha:this.$captchaInput.val()}),this.listenToOnce(this.model,"invalid",function(){"useremail_is_empty"===this.model.validationError?this.$emailInput.addClass("re-input-error"):this.$emailInput.removeClass("re-input-error")});var s=this,n=function(t,e,n){s.$captchaInput.parent("label").hide(),s.$emailInput.attr("disabled","disabled"),s._changeButtonState(s.$retrieveActionButton,!0,"找回密码邮件已发送")},i=function(t,n,i){var a=n.responseJSON,r=["retrieve_email_invalid","account_can_not_use","token_already_exist","unknown_error_occurred","retrieve_email_send_failure","invalid_captcha","token_auth_failed"];-1!==_.indexOf(r,a.status_short)&&e.push(a.status_detail,"warning"),a.token&&(s.model.set({token:a.token}),_s["APP.token"]=a.token),$("img.captcha").attr("src",_s["SYS_CFG.site_uri"]+"captcha?"+Math.random()),s._changeButtonState(s.$retrieveActionButton,!1,"发送找回密码邮件")};this.model.save(null,{success:n,error:i})}}),d=r.extend({el:".verification-main",events:{"click .goto-login":"gotoLogin","click .goto-register":"gotoRegister"},gotoLogin:function(t){t&&t.preventDefault(),location.href=_s["SYS_CFG.site_url"]+"login/"},gotoRegister:function(t){t&&t.preventDefault(),location.href=_s["SYS_CFG.site_url"]+"register/"}}),h=r.extend({el:"body",events:{"click #change-captcha":"changeCaptcha","click #show-password":"showPassword","submit .set-new-password":"saveNewPassword"},initialize:function(){this.$passwordInput=this.$(".new-password-input")},saveNewPassword:function(t){t&&t.preventDefault(),this._changeButtonState(this.$(".save-new-password"),!0,"请求更改密码···"),this.model.save({retrieve_token:_s["USER.retrieve_token"],new_password:this.$passwordInput.val()},{context:this,success:function(t,e){e&&"new_password_saved"===e.status_short&&(this._changeButtonState(this.$(".save-new-password"),!0,"正在转到登录···"),window.setTimeout(function(){location.href=_s["SYS_CFG.site_url"]+"login/"},3e3))},error:function(t,s){s&&s.token&&(this._changeButtonState(this.$(".save-new-password"),!1,"完成"),_s["APP.token"]=s.token,_s.reqErrorHandle(s,"请求失败：",null,!0,"warning",e))}})},showPassword:function(t){t.preventDefault();var e=this.$passwordInput.attr("type");return"password"===e?(this.$passwordInput.attr("type","text"),void $(t.target).text("隐藏密码")):($(t.target).text("显示密码"),void this.$passwordInput.attr("type","password"))}}),c=r.extend({el:"body",events:{"submit .resend-email":"emailResend","click #change-captcha":"changeCaptcha"},initialize:function(){this.emailModel=new(t.Model.extend({url:_s["SYS_CFG.site_uri"]+"user/email/resend/"})),console.log(this.emailModel),this.$resendButton=this.$(".resend")},emailResend:function(t){t&&t.preventDefault(),this._changeButtonState(this.$resendButton,!0,"请求发送新的邮件···"),this.emailModel.save({token:_s["APP.token"],email:this.$(".email-addr").val()},{context:this,success:function(t,e){e&&"verification_email_resended"===e.status_short&&this._changeButtonState(this.$resendButton,!0,e.status_detail)},error:function(t,s){s&&s.token&&(this._changeButtonState(this.$resendButton,!1,"完成"),_s["APP.token"]=s.token,_s.reqErrorHandle(s,"请求失败：",null,!0,"warning",e))}})}});$("#login-form").length&&new o({model:new s}),$("#register-form").length&&new u({model:new n}),$("#retrieve-form").length&&new l({model:new i}),$(".verification-main").length&&new d,$(".set-new-password").length&&new h({model:new a}),$(".resend-email").length&&new c});