define(["backbone","notifications"],function(e,t){var n=function(){return{}},s=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/global/common/"}),i=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/global/register/"}),o=e.Model.extend({idAttribute:"task_id"}),r=e.View.extend({template:_.template($("#template-task").html()),render:function(){return this.template(this.model.attributes)}}),a=e.Collection.extend({model:o,url:_s["SYS_CFG.site_uri"]+"setting/global/task/"}),l=e.Model.extend({idAttribute:"organization_id"}),d=e.View.extend({template:_.template($("#template-organization").html()),render:function(){return this.template(this.model.attributes)}}),c=e.Collection.extend({model:l,url:_s["SYS_CFG.site_uri"]+"setting/global/organization/"}),u=e.Model.extend({idAttribute:"user_id"}),m=e.View.extend({template:_.template($("#template-user").html()),render:function(){return this.template(this.model.attributes)}}),g=e.Collection.extend({model:u,url:_s["SYS_CFG.site_uri"]+"setting/global/user/"}),h=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/personal/session/",initialize:function(){this.url+=this.id+"/"+this.get("expire")},idAttribute:"session_id"}),p=e.Collection.extend({model:h}),f=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/personal/profile/",parse:n}),b=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/personal/common/",parse:n}),v=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"setting/personal/security/"}),k=e.View.extend({el:".setting-personal-profile",events:{"submit .re-form":"saveSetting"},saveSetting:function(e){e&&e.preventDefault(),$(e.target).find("button[type=submit]").attr("disabled",!0),this.model.save({gender:+this.$("input[name=user-gender]").filter(":checked").val(),public_email:+this.$("input[name=public-email]").is(":checked"),token:_s["APP.token"]},{context:this,success:function(e,n){n&&"profile_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("资料设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find("button[type=submit]").removeAttr("disabled")}})}}),w=e.View.extend({el:".setting-personal-common",events:{"submit .re-form":"saveSetting"},saveSetting:function(e){e&&e.preventDefault(),$(e.target).find("button[type=submit]").attr("disabled",!0),this.model.save({receive_message:+this.$("input[name=receive-message]").filter(":checked").val(),token:_s["APP.token"]},{context:this,success:function(e,n){n&&"common_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("通用设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find("button[type=submit]").removeAttr("disabled")}})}}),S=e.View.extend({el:".setting-personal-security",events:{"submit .re-form":"saveSetting","click .show-new-password":"toggleNewPassword","click .show-old-password":"toggleOldPassword"},togglePasswordInput:function(e,t){"password"===t.attr("type")?(t.attr("type","text"),e.text("隐藏密码")):"text"===t.attr("type")&&(t.attr("type","password"),e.text("显示密码"))},toggleNewPassword:function(e){e&&e.preventDefault(),this.togglePasswordInput($(e.target),this.$("input[name=new-password]"))},toggleOldPassword:function(e){e&&e.preventDefault(),this.togglePasswordInput($(e.target),this.$("input[name=old-password]"))},saveSetting:function(e){e&&e.preventDefault(),$(e.target).find("button[type=submit]").attr("disabled",!0),this.model.save({old_password:this.$("input[name=old-password]").val(),new_password:this.$("input[name=new-password]").val(),token:_s["APP.token"]},{context:this,success:function(e,n){n&&"security_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("通用设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find("button[type=submit]").removeAttr("disabled")}})}}),P=e.View.extend({el:".setting-personal-session",events:{"click .remove":"removeSession"},removeSession:function(e){e&&e.preventDefault();var n=$(e.target);n.attr("disabled",!0);var s=n.parents("tr").data("session-id"),i=this.collection.get(s);i.destroy({context:this,success:function(e,t){t&&"session_deleted"===t.status_short&&n.parents("tr").remove()},error:function(e,n){_s.reqErrorHandle(n,"删除会话失败：",null,!0,"warning",t)},complete:function(){n.removeAttr("disabled")}})}}),x=e.View.extend({el:".setting-global-user",events:{"click .load-user":"loadUser","click .load-more":"loadUser"},initialize:function(){this.listenTo(this.collection,"sync",this.render)},fetchBlocked:0,loadUser:function(e){$(e.target).attr("disabled",!0),this.collection.fetch({data:{start:this.collection.size()+1,amount:20,blocked:this.fetchBlocked},remove:!1,context:this,error:function(e,n){return n&&"no_users"===n.responseJSON.status_short?this.$("tfoot").addClass("hidden"):void _s.reqErrorHandle(n,"加载失败：",null,!0,"warning",t)},complete:function(){return this.collection.size()?void $(e.target).removeAttr("disabled"):$(e.target).text("没有找到用户")}})},render:function(){this.collection.size()&&(this.$(".re-table").removeClass("hidden"),this.$(".load-user").addClass("hidden")),this.collection.each(function(e){this.$("tr[data-user-id="+e.id+"]").length||this.$("tbody").append(new m({model:e}).render())},this)}}),y=x.extend({el:".setting-global-blocked-user",fetchBlocked:1}),z=e.View.extend({el:".setting-global-organization",events:{"click .load-organization":"loadOrganization","click .load-more":"loadOrganization"},initialize:function(){this.listenTo(this.collection,"sync",this.render)},loadOrganization:function(e){$(e.target).attr("disabled",!0),this.collection.fetch({data:{start:this.collection.size()+1,amount:20},remove:!1,context:this,error:function(e,n){return n&&"no_organizations"===n.responseJSON.status_short?this.$("tfoot").addClass("hidden"):void _s.reqErrorHandle(n,"加载失败：",null,!0,"warning",t)},complete:function(){return this.collection.size()?void $(e.target).removeAttr("disabled"):$(e.target).text("没有找到组织")}})},render:function(){this.collection.size()&&(this.$(".re-table").removeClass("hidden"),this.$(".load-organization").addClass("hidden")),this.collection.each(function(e){this.$("tr[data-organization-id="+e.id+"]").length||this.$("tbody").append(new d({model:e}).render())},this)}}),A=e.View.extend({el:".setting-global-task",events:{"click .load-task":"loadTask","click .load-more":"loadTask"},initialize:function(){console.log(this),this.listenTo(this.collection,"sync",this.render)},loadTask:function(e){$(e.target).attr("disabled",!0),this.collection.fetch({data:{start:this.collection.size()+1,amount:20},remove:!1,context:this,error:function(e,n){return n&&"no_tasks"===n.responseJSON.status_short?this.$("tfoot").addClass("hidden"):void _s.reqErrorHandle(n,"加载失败：",null,!0,"warning",t)},complete:function(){return this.collection.size()?void $(e.target).removeAttr("disabled"):$(e.target).text("没有找到任务")}})},render:function(){this.collection.size()&&(this.$(".re-table").removeClass("hidden"),this.$(".load-task").addClass("hidden")),this.collection.each(function(e){this.$("tr[data-task-id="+e.id+"]").length||this.$("tbody").append(new r({model:e}).render())},this)}}),C=e.View.extend({el:".setting-global-common",events:{"submit form":"saveCommon"},saveCommon:function(e){e&&e.preventDefault(),$(e.target).find("button[type=submit]").attr("disabled",!0),this.model.save({login_captcha:+this.$("input[name=login-captcha]").is(":checked"),anonymous_access:+this.$("input[name=anonymous-access]").is(":checked"),member_create_organization:+this.$("input[name=member-create-organization]").is(":checked"),token:_s["APP.token"]},{success:function(e,n){n&&"global_common_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("通用设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find("button[type=submit]").removeAttr("disabled")}})}}),O=e.View.extend({el:".setting-global-register",events:{"submit form":"saveRegister"},saveRegister:function(e){e&&e.preventDefault(),$(e.target).find("button[type=submit]").attr("disabled",!0),this.model.save({register:+this.$("input[name=register]").is(":checked"),send_email:+this.$("input[name=send-email]").is(":checked"),token:_s["APP.token"]},{success:function(e,n){n&&"global_register_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("注册设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find("button[type=submit]").removeAttr("disabled")}})}});1===_s["SETTING.page_type"]?(new k({model:new f({gender:_s["SETTING.gender"],public_email:_s["SETTING.public_email"]})}),new w({model:new b({receive_message:_s["SETTING.receive_message"]})}),new S({model:new v}),new P({collection:new p(_s["USER.sessions"])})):2===_s["SETTING.page_type"]&&(new x({collection:new g}),new y({collection:new g}),new z({collection:new c}),new A({collection:new a}),new C({model:new s({login_captcha:_s["OPTIONS.login_captcha"],anonymous_access:_s["OPTIONS.anonymous_access"],member_create_organization:_s["OPTIONS.member_create_organization"]})}),new O({model:new i({register:_s["OPTIONS.register"],send_email:_s["OPTIONS.send_email"]})}))});