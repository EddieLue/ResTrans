define(["backbone","notifications"],function(e,t){var n=e.Model.extend({url:_s["SYS_CFG.site_uri"]+"profile/"+_s["OTHERSIDE.user_id"]+"/setting/"}),i=e.Model.extend({idAttribute:"organization_id"}),o=e.View.extend({template:_.template($("#template-profile-organization").html()),render:function(){return this.template(this.model.attributes)}}),s=e.Collection.extend({model:i,url:_s["SYS_CFG.site_uri"]+"profile/"+_s["OTHERSIDE.user_id"]+"/organization/"}),r=e.View.extend({el:".user-control",events:{"click .close":"close","submit .user-control-options":"save"},show:function(){this.$el.removeClass("hidden")},save:function(e){e&&e.preventDefault(),$(e.target).find(".save").attr("disabled",!0),this.model.save({blocked:+this.$("input[name=user-status]").is(":checked"),send_message:+this.$("input[name=send-message]").is(":checked"),token:_s["APP.token"]},{success:function(e,n){n&&"user_settings_saved"===n.status_short&&n.token&&(_s["APP.token"]=n.token,t.push("用户设置已保存。","success"))},error:function(e,n){_s.reqErrorHandle(n,"保存设置失败：",null,!0,"warning",t),_s["APP.token"]=n.responseJSON.token},complete:function(){$(e.target).find(".save").removeAttr("disabled")}})},close:function(e){e&&e.preventDefault(),this.$el.addClass("hidden")}}),a=e.View.extend({el:".profile-top",events:{"click .options .open-user-control":"openUserControlDialog"},initialize:function(){this.userControlDialog=new r({p:this,model:new n({blocked:_s["OTHERSIDE.blocked"],send_message:_s["OTHERSIDE.send_message"]})})},openUserControlDialog:function(e){this.userControlDialog.show()}}),l=e.View.extend({el:".profile-organizations",events:{"click .load-more button":"loadOrganizations"},initialize:function(){this.organizations=new s(_s["OTHERSIDE.organizations"]),this.listenTo(this.organizations,"sync",this.render),this.listenTo(this.organizations,"sync",this.refreshLoadingButtonState),this.listenTo(this.organizations,"error",this.refreshLoadingButtonState)},loadOrganizations:function(e){e&&e.preventDefault(),$(e.target).attr("disabled",!0),this.organizations.fetch({data:{start:this.organizations.size()+1,amount:20},context:this,error:function(e,n){_s.reqErrorHandle(n,"设置失败：",null,!0,"warning",t)},remove:!1,merge:!1})},render:function(){this.organizations.each(function(e){this.$("tr[data-organization-id="+e.id+"]").length||this.$("tbody").append(new o({model:e}).render())},this)},refreshLoadingButtonState:function(){this.$(".load-more button").removeAttr("disabled"),this.organizations.size()>=_s["OTHERSIDE.organization_total"]&&this.$("tfoot").addClass("hidden")}});new a,new l});