define(["backbone","notifications"],function(t,e){var i=t.Model.extend({idAttribute:"organization_id"}),n=t.Collection.extend({model:i,url:_s["SYS_CFG.site_uri"]+"organization/"}),a=t.View.extend({template:_.template($("#template-organization").html()),render:function(){return this.template(this.model.attributes)}}),s=t.Model.extend({idAttribute:"task_id"}),r=t.Collection.extend({model:s,url:_s["SYS_CFG.site_uri"]+"start/task/"}),o=t.View.extend({template:_.template($("#template-start-task").html()),render:function(){return this.template(this.model.attributes)}}),l=t.View.extend({el:".organizations",events:{"click .page-forward":"fetchOrganizations"},initialize:function(){this.collection=new n(_s["HOME.organizations"]),this.listenTo(this.collection,"sync",this.render)},fetchOrganizations:function(t){t&&t.preventDefault(),$(t.target).attr("disabled",!0),this.collection.fetch({data:{start:this.collection.size()+1},merge:!1,remove:!1,context:this,error:function(t,i){_s.reqErrorHandle(i,"拉取更多组织失败",null,!0,"",e)},complete:function(){$(t.target).removeAttr("disabled")}})},render:function(t,e){e.length<1&&this.$(".page-forward").remove(),t.each(function(t){if(!this.$("tr[data-organization-id="+t.id+"]").length){var e=new a({model:t});this.$("tbody").append(e.render()),e.setElement(this.$("tr[data-organization-id="+t.id+"]"))}},this)}}),d=t.View.extend({el:".tasks",events:{"click .page-forward":"fetchTasks"},initialize:function(){this.collection=new r(_s["HOME.tasks"]),this.listenTo(this.collection,"sync",this.render)},fetchTasks:function(t){t&&t.preventDefault(),$(t.target).attr("disabled",!0),this.collection.fetch({data:{start:this.collection.size()+1},merge:!1,remove:!1,context:this,error:function(t,i){_s.reqErrorHandle(i,"拉取更多任务失败",null,!0,"",e)},complete:function(){$(t.target).removeAttr("disabled")}})},render:function(t,e){e.length<1&&this.$("tfoot").remove(),t.each(function(t){if(!this.$("tr[data-task-id="+t.id+"]").length){var e=new o({model:t});this.$("tbody").append(e.render()),e.setElement(this.$("tr[data-task-id="+t.id+"]"))}},this)}}),h=t.Model.extend(),c=t.View.extend({taskTemplate:_.template($("#template-search-item-t").html()),organizationTemplate:_.template($("#template-search-item-o").html()),render:function(){return"task_id"===this.model.idAttribute?this.taskTemplate(this.model.attributes):this.organizationTemplate(this.model.attributes)}}),u=t.Collection.extend({url:_s["SYS_CFG.site_uri"]+"search/",initialize:function(t,e){0===e.type&&(this.model=h.extend({idAttribute:"task_id"})),1===e.type&&(this.model=h.extend({idAttribute:"organization_id"}))}}),m=t.View.extend({el:".result",events:{"click .load-tasks":"loadTasks","click .load-organizations":"loadOrganizations"},initialize:function(){this.tasks=new u(_s["SEARCH.tasks"],{type:0}),this.organizations=new u(_s["SEARCH.organizations"],{type:1}),this.listenTo(this.organizations,"sync",this.renderO),this.listenTo(this.tasks,"sync",this.renderT)},loadTasks:function(t){t&&t.preventDefault(),this.tasks.fetch({data:{s_kw:_s["SEARCH.kw"],s_t:"t",start:this.tasks.size()+1},remove:!1,merge:!1,context:this,error:function(){this.$(".load-tasks").remove()}})},loadOrganizations:function(t){t&&t.preventDefault(),this.organizations.fetch({data:{s_kw:_s["SEARCH.kw"],s_t:"o",start:this.organizations.size()+1},remove:!1,merge:!1,context:this,error:function(){this.$(".load-organizations").remove()}})},renderT:function(t,e){return this.render.call(this,this.tasks,e)},renderO:function(t,e){return this.render.call(this,this.organizations,e)},render:function(t,e){var i=t===this.tasks?0:1;e&&e.length<1&&(i?this.$(".load-organizations").remove():this.$(".load-tasks").remove()),t.each(function(t){if(!(!i&&this.$(".task[data-task-id="+t.id+"]").length||i&&this.$(".organization[data-organization-id="+t.id+"]").length)){var e=new c({model:t});i?this.$(".organization-result").append(e.render()):this.$(".task-result").append(e.render())}},this)}});new l,new d,new m});