define(["backbone","notifications","autosize","message"],function(t,e,i,s){var n=t.Model.extend({idAttribute:"file_id",validate:function(t){return t.best_translation||t.newest_translation||t.machine_translation||t.source?void 0:(e.push("你必须至少选择一个选项。"),"must_select")}}),a=t.Collection.extend({model:n,url:_s["SYS_CFG.site_uri"]+"worktable/"+_s["WORKTABLE.hash"]+"/download/link/"}),l=t.Model.extend({idAttribute:"translation_id",setUrlRoot:function(t,e){t=t?t:this.collection.fileModel.collection.fileSet.id,e=e?e:this.collection.fileModel.id,this.urlRoot=_s["SYS_CFG.site_uri"]+"worktable/"+_s["WORKTABLE.hash"],this.urlRoot+="/set/"+t+"/file/"+e+"/translation/"}}),o=t.Collection.extend({model:l,setUrl:function(t,e){this.url=_s["SYS_CFG.site_uri"]+"worktable/"+_s["WORKTABLE.hash"],this.url+="/set/"+t+"/file/"+e+"/translation/"}}),r=t.View.extend({templateTranslation:_.template($("#template-translation").html()),render:function(){return this.templateTranslation({translation_id:this.model.id?this.model.id:this.model.cid,content:this.model.get("text"),is_best:this.model.get("best_translation"),has_best:this.model.get("best_translation")||!!this.model.collection.getBestTranslation(),not_save:this.model.isNew(),contribute_time:this.model.get("friendly_time"),contributor_name:this.model.get("contributor_name"),contributor:this.model.get("contributor")})}}),d=t.Collection.extend({model:l,initialize:function(t,e){this.fileModel=e.fileModel,this.url=_s["SYS_CFG.site_uri"]+"task/"+_s["WORKTABLE.task_id"],this.url+="/set/"+e.fileModel.collection.fileSet.id,this.url+="/file/"+e.fileModel.id+"/translation/"},getBestTranslation:function(){return this.bestTranslation=this.bestTranslation?this.bestTranslation:this.findWhere({best_translation:1})},myTranslation:function(){return this.findWhere({contributor:_s["USER.user_id"]})}}),h=t.Model.extend({idAttribute:"line_number",initialize:function(){this.fileModel=this.collection.fileModel,this.translations=new d(this.get("translations"),{fileModel:this.fileModel}),this.unset("translations")}}),c=t.View.extend({templateLineOnly:_.template($("#template-line-only").html()),templateTranslatedText:_.template($("#template-translated-text").html()),templateBestTranslation:_.template($("#template-best-translation").html()),renderLineOnly:function(t,e){var i="",s=this.model.translations;return s.size()&&s.each(function(t){var e=new r({model:t});i+=e.render()}),this.templateLineOnly({line:this.model.get("line_number"),need:this.model.get("translate")?"":" no-need",content:this.model.get("text"),addition:t?t:"",display_candidates:e?"":" hidden",candidate_translations:i})},renderTranslatedText:function(){var t=_.escape(this.model.get("machine_translation")),e=t?t:"输入译文",i=this.model.translations.myTranslation(),s=i?i.get("text"):"";return this.templateTranslatedText({machine_translation:e,text:s,line:this.model.get("line_number")})},renderBestTranslation:function(){if(!this.model.translations.getBestTranslation())return this.templateBestTranslation({translation_id:0,show_best_translation:" hidden",best_translation_text:"",contributor:"",proofreader:""});var t=this.model.translations.bestTranslation;return this.templateBestTranslation({translation_id:this.model.translations.bestTranslation.id,show_best_translation:"",best_translation_text:this.model.translations.bestTranslation.get("text"),contributor:'<a target="_blank" href="'+_s["SYS_CFG.site_url"]+"profile/"+t.escape("contributor")+'" title="翻译者">'+t.escape("contributor_name")+"</a>",proofreader:'<a target="_blank" href="'+_s["SYS_CFG.site_url"]+"profile/"+t.escape("proofreader")+'" title="校对者">'+t.escape("proofreader_name")+"</a>"})},render:function(){if(!this.model.get("translate"))return this.renderLineOnly();var t=this.renderTranslatedText(),e=this.renderBestTranslation(),i=!this.model.translations.getBestTranslation();return this.renderLineOnly(t+e,i)}}),f=t.Collection.extend({model:h,initialize:function(t,e){this.fileModel=e.fileModel,this.setUrl()},setUrl:function(){this.url=_s["SYS_CFG.site_uri"]+"task/"+_s["WORKTABLE.task_id"]+"/set/",this.url+=this.fileModel.collection.fileSet.id+"/file/"+this.fileModel.id+"/line/"},comparator:"line_number"}),u=t.Model.extend({idAttribute:"file_id",alreadyFetched:!1,initialize:function(){this.lines=new f(null,{fileModel:this})},setUrlRoot:function(){this.url=_s["SYS_CFG.site_uri"]+"worktable/"+_s["WORKTABLE.hash"],this.url+="/set/"+this.collection.fileSet.id,this.url+="/file/"+this.id}}),g=t.Collection.extend({model:u,alreadyFetched:!1,initialize:function(t,e){this.url=_s["SYS_CFG.site_uri"]+"task/"+_s["WORKTABLE.task_id"],this.url+="/set/"+e.set.id+"/file/",this.fileSet=e.set}}),p=t.View.extend({events:{"click .file-meta .name":"openFile","click .file-options .download":"downloadFile","click .file-options .delete":"deleteFile"},openFile:function(t){t.preventDefault(),this.workTableTop.openFile(this.model)},downloadFile:function(t){t.preventDefault(),this.workTableTop.downloadDialog.trigger("showDownloadDialog",this.model)},deleteFile:function(t){t.preventDefault(),this.workTableTop.deleteFileDialog.trigger("showDeleteDialog",this.model,function(){this.remove();var t=this.workTableTop.fm;t.setCollection;t.trigger("refreshFileTips")},this)},initialize:function(t){this.workTableTop=t.wtt},uploadFileTemplate:_.template($("#template-file-manager-upload").html()),fileTemplate:_.template($("#template-file-manager-file").html()),renderUpload:function(){return this.uploadFileTemplate({cid:this.model.cid,name:this.model.get("name"),status:"0%"})},renderFile:function(){return this.fileTemplate({id:this.model.id,name:this.model.get("name"),ext:"."+this.model.get("ext"),line:this.model.get("line"),percentage:this.model.get("percentage"),last_contributor:this.model.get("last_contributor"),last_update:this.model.get("last_update"),last_update_by:this.model.get("last_update_by")})},render:function(t){return"upload"===t?this.renderUpload():this.renderFile()}}),w=t.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"task/"+_s["WORKTABLE.task_id"]+"/set/",idAttribute:"set_id",initialize:function(){this.files=new g(null,{set:this})},validate:function(t){return!$.trim(t.name)}}),m=t.Collection.extend({model:w,url:_s["SYS_CFG.site_uri"]+"task/"+_s["WORKTABLE.task_id"]+"/set/"}),v=t.View.extend({events:{"click a":"switch"},initialize:function(t){this.fm=t.fm,this.listenTo(this.fm.setCollection,"remove",function(t){this.model.id===t.id&&this.remove()})},"switch":function(t){this.fm.switchSet(t)},template:_.template('<li class="set" data-set-id="<%= id %>"><a href=""><%- name %></a></li>'),render:function(){return this.template({id:this.model.id,name:this.model.get("name")})}}),b=t.View.extend({el:".create-set-dialog",events:{"submit .create-set":"create","click .close-dialog":"close"},noSets:function(){this.$(".close-dialog").hide()},initialize:function(t){this.workTableTop=t.wtt},close:function(t){t.preventDefault(),this.$el.addClass("hidden")},create:function(t){t.preventDefault();var i=$(t.target),s=i.find(".set-name"),n=i.find("button[type=submit]"),a=new w({token:_s["APP.token"]}),l=function(){n.removeAttr("disabled"),n.text("创建集")};n.attr("disabled",""),n.text("创建集···"),a.set({name:s.val()},{validate:!0}),a.validationError&&(e.push("请输入文件集的名称。","warning"),l.call(this));var o=function(t,i){n.text("正在完成…"),"create_set_succeed"===i.status_short&&(_s["APP.token"]=i.token,t.unset("token"),this.workTableTop.trigger("createSet",t),this.$el.addClass("hidden"),e.push("文件集已创建。","success"))},r=function(t,i){var s=i.responseJSON;_s["APP.token"]=s.token,a.set({token:_s["APP.token"]=s.token}),_.has(s,"status_detail")&&e.push(s.status_detail,"warning")};a.save(null,{success:o,error:r,context:this,complete:function(){l.call(this)}})}}),T=t.View.extend({el:".choose-file-language",events:{"click .cancel":"closeDialog","click .continue":"continueUpload"},initialize:function(t){this.workTableTop=t.wtt},showDialog:function(t){var e=this.$el,i=_.template($("#template-file-language-settings").html());e.find(".language-selector .selector").remove(),_.each(t.target.files,function(t){e.find(".language-selector").append(i({file_name:t.name}))},this);var s=_s["WORKTABLE.default_original_language"],n=_s["WORKTABLE.default_target_language"];e.find(".select-original-language option[value="+s+"]").attr("selected",!0),e.find(".select-target-language option[value="+n+"]").attr("selected",!0),this.files=t.target.files,e.show()},closeDialog:function(t){t.preventDefault(),this.$el.hide()},continueUpload:function(t){this.files||e.push("无法继续，你所选择的文件列表已丢失。");var i=[],s=this.files;this.$("li.selector").each(function(t){var e=$(this),n=e.find(".select-original-language .re-select option").filter(":selected").val(),a=e.find(".select-target-language .re-select option").filter(":selected").val();i.push({fileObj:s[t],original_language:n,target_language:a})}),this.workTableTop.trigger("uploadFiles",i),this.closeDialog(t)}}),k=t.View.extend({el:".before-switch-file",events:{"click .save-now":"save","click .discard":"discard","click .cancel":"hide"},file:void 0,initialize:function(t){this.workTableTop=t.wtt},save:function(t){this.trigger("save",t)},discard:function(t){this.trigger("discard",t)},show:function(t){t&&t.preventDefault(),this.$el.show()},hide:function(t){t.preventDefault(),this.$el.hide()}}),x=t.View.extend({el:".goto-line-dialog",events:{"submit .go":"go","click .close":"close"},initialize:function(t){this.workTableTop=t.wtt,this.on("close",this.close)},go:function(t){t.preventDefault(),this.trigger("gotoLine",this.$(".ln").val())},show:function(t){t&&t.preventDefault(),this.$el.show(),this.$(".ln").focus()},close:function(t){t&&t.preventDefault(),this.$el.hide()}}),S=t.View.extend({el:".delete-file-dialog",events:{"click .delete":"delete","click .close":"close"},initialize:function(t){this.workTableTop=t.wtt,this.on("showDeleteDialog",this.show,this)},"delete":function(t){t&&t.preventDefault();var i=$(t.target);i.attr("disabled",!0),this.file.setUrlRoot(),this.file.destroy({success:function(){e.push("文件已删除。","success");var t=this.workTableTop.main;t.fm.lf(void 0),t.clearLines(),t.trigger("resetTitle","",""),t.trigger("changeTitle",""),t.trigger("changeLanguage","未知原始语言","未知目标语言"),this.callback&&this.callbackContext&&this.callback.call(this.callbackContext),this.close()},error:function(){e.push("文件删除失败。","warning"),this.close()},context:this})},show:function(t,e,i){this.$el.removeClass("hidden"),this.$(".delete").removeAttr("disabled"),this.$(".fn").text(t.escape("name")),this.file=t,this.callback=e,this.callbackContext=i},close:function(t){t&&t.preventDefault(),this.$el.addClass("hidden")}}),C=t.View.extend({el:".download-fallback-setting-dialog",events:{"click .start-download":"startDownload","click .cancel":"cancel"},initialize:function(t){this.workTableTop=t.wtt,this.on("showDownloadDialog",this.show,this)},show:function(e){var i=function(t){return{file_id:t.id}};e instanceof t.Model?e=[i.call(this,e)]:e instanceof t.Collection&&(e=e.map(i,this)),this.downloads=new a(e),this.downloads.size()&&(this.$(".start-download").text("下载 "+this.downloads.size()+" 个文件").removeAttr("disabled"),this.$el.show())},startDownload:function(t){this.$(".start-download").text("即将开始···").attr("disabled",!0);var i,s=function(){this.$(".start-download").text("下载 "+this.downloads.size()+" 个文件").removeAttr("disabled")};return this.downloads.each(function(t){t.set({best_translation:!!+this.$("input[name=best-translation]").filter(":checked").val(),newest_translation:!!+this.$("input[name=newest-translation]").filter(":checked").val(),machine_translation:!!+this.$("input[name=machine-translation]").filter(":checked").val(),source:!!+this.$("input[name=source]").filter(":checked").val()},{validate:!0}),i=t.validationError?t.validationError:null},this),i?s.call(this):void this.downloads.sync("create",this.downloads,{success:function(t){"download_link_created"===t.status_short&&(location.href=t.download_link),s.call(this),this.cancel(),e.push("下载已开始。","success")},error:function(t){t=t.responseJSON,"download_link_created"!==t.status_short&&e.push(t.status_detail,"error"),s.call(this),e.push("下载失败。","warning")},context:this})},cancel:function(t){t&&t.preventDefault(),this.$el.hide()}}),L=t.View.extend({events:{"click .toggle-sidebar":"toggleSidebar"},initialize:function(t){this.workTableTop=t.wtt},toggleSidebar:function(t){t.preventDefault(),this.workTableTop.toggleSidebar(this.$el)}}),F=L.extend({el:".worktable .top .nav .cm-main"}),D=L.extend({el:".worktable .top .nav .glossary-main"}),R=L.extend({el:".worktable .top .nav .fm-main",events:{"click .toggle-sidebar":"toggleSidebar","click .select-set .current-set":"toggleSetList","change .upload-files .select-button":"showLanguageSettings","click .files-options .create-set":"showCreateSetDialog","click .files-options .refresh-set-list":"requestSetCollection","click .files-options .refresh-file-list":"requestFileCollection"},initialize:function(t){var e=_s["WORKTABLE.max_upload_file_size"],i=e.substring(e.length-1),s=_s["WORKTABLE.last_set"]?_s["WORKTABLE.last_set"]:void 0,n=_s["WORKTABLE.last_file"]?_s["WORKTABLE.last_file"]:void 0;switch(i){case"K":case"k":this.uploadFileMax=1024*e.substring(0,e.length-1);break;case"M":case"m":this.uploadFileMax=1048576*e.substring(0,e.length-1);break;case"G":case"g":this.uploadFileMax=1073741824*e.substring(0,e.length-1);break;default:this.uploadFileMax=e}this.$setList=this.$(".select-set ul.set-list"),this.workTableTop=t.wtt,this.setCollection=new m(_s["WORKTABLE.sets"]),this.setCollection.each(function(t){var e=new v({model:t,fm:this});e.setElement(this.$setList.find(".set[data-set-id="+t.id+"]"))},this),s&&(this.ls(this.setCollection.get(s.set_id)),_s["WORKTABLE.last_set_files"]&&this.ls().files.reset(_s["WORKTABLE.last_set_files"])&&(this.ls().files.alreadyFetched=!0),this.insertFiles(this.ls().files,!1)),this.ls()&&n&&this.lf(this.ls().files.get(n.file_id)),this.on("refreshFileTips",function(){var t=this.$(".file-list .files li.no-files");this.$(".file-list .files li.file").length?t.addClass("hidden"):t.removeClass("hidden")},this),this.listenTo(this.setCollection,"remove",function(t,e){e.size()||(this.$(".select-set .current-set").text("无文件集"),this.showCreateSetDialog(),this.workTableTop.noSets())}),this.on("reRenderFile",function(t){var e=this.$(".file-list .files li.file[data-file-id="+t.id+"]");e.length&&(e.remove(),this.insertFiles(t,!0))},this),this.trigger("refreshFileTips")},ls:function(t){return Object.prototype.hasOwnProperty.call(arguments,0)?this.lastSet=t:this.lastSet},lf:function(t){return Object.prototype.hasOwnProperty.call(arguments,0)?this.lastFile=t:this.lastFile},listResize:function(t){this.$(".file-list").height(t-110)},displaySetList:!1,toggleSetList:function(t){t&&t.preventDefault(),this.displaySetList?this.$setList.css("display","none"):this.$setList.css("display","block"),this.displaySetList=!this.displaySetList},_insert:function(t,e){var i=new p({model:t,wtt:this.workTableTop});e&&this.renderInsertFiles(i.render("file")),i.setElement(this.$(".file-list .files li.file[data-file-id="+t.id+"]"))},insertFiles:function(e,i){return e instanceof t.Model?this._insert(e,i):(e.each(function(t){var e=this;return function(i){e._insert(i,t)}}.call(this,i),this),void this.trigger("refreshFileTips"))},switchSet:function(t){t.preventDefault(),this.toggleSetList();var e=$(t.target),i=e.parent().data("set-id"),s=this.setCollection.get(i);this._switchSet(s)},_switchSet:function(t){this.workTableTop.main.loading("打开集");var e=function(){this.workTableTop.main.hideLoading(),this.requestingFileCollection=!1};t||returnreset.call(this);var i=t.files;return i.alreadyFetched?(e.call(this),this.$(".file-list .files li.file").remove(),this.insertFiles(i,!0),void this.currentSet(i.fileSet)):void this.fetchFile(i)},requestFileCollection:function(t){t.preventDefault(),this.workTableTop.main.loading("打开集"),this.requestingFileCollection||this.fetchFile(this.ls().files)},requestingFileCollection:!1,fetchFile:function(t){if(!this.requestingFileCollection){this.requestingFileCollection=!0;var i=function(){this.workTableTop.main.hideLoading(),this.requestingFileCollection=!1},s=function(){this.$(".file-list .files li.file").remove()},n=function(t,e){i.call(this),s.call(this),e.length&&(this.insertFiles(t,!0),t.alreadyFetched=!0,this.currentSet(t.fileSet))},a=function(t,n){i.call(this),s.call(this);var n=n.responseJSON,a=n.status_detail?n.status_detail:"";"file_not_found"===n.status_short||e.push("打开集的时候发生错误。"+a,"warning"),"set_not_found"===n.status_short?this.setCollection.remove(t.fileSet):(this.insertFiles(t,!0),this.currentSet(t.fileSet))};t.fetch({reset:!0,success:n,error:a,context:this})}},currentSet:function(t){this.$(".select-set .current-set").html(t.get("name")+'<i class="down-arrow"></i>'),this.ls(t)},showLanguageSettings:function(t){return this.ls()?void(t.target.files.length&&this.workTableTop.trigger("showLanguageSettingsDialog",t)):void e.push("出现了问题，请刷新文件集或文件列表然后再试一次。","warning")},uploadFiles:function(t){_.each(t,function(t){if(t.fileObj.size>this.uploadFileMax)return void e.push("「"+t.fileObj.name+"」文件大小不符合上传标准。","warning");var i=this.ls().files.add({name:t.fileObj.name,size:t.fileObj.size,target_language:t.target_language,original_language:t.original_language},{collection:this.ls().files}),s=new p({model:i,wtt:this.workTableTop}),n=new FormData;uploadURL=_s["SYS_CFG.site_uri"]+"worktable/"+_s["WORKTABLE.hash"],uploadURL+="/set/"+this.ls().id+"/file/";var a=new XMLHttpRequest,l=function(t,e,i){var s=this;return function(n){s[t](n,e,i)}};this.renderInsertFiles(s.render("upload")),s.setElement(this.$(".file-list .files .temporary-file[data-file-cid="+i.cid+"]")),a.addEventListener("progress",l.call(this,"uploadProgress",i,s),!1),a.addEventListener("load",l.call(this,"uploadCompleted",i,s),!1),a.addEventListener("error",l.call(this,"uploadFailed",i,s),!1),a.addEventListener("loadend",l.call(this,"uploadEnd",i,s),!1),a.open("POST",uploadURL,!0),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.setRequestHeader("Accept","application/json"),n.append("file",t.fileObj),n.append("original_language",t.original_language),n.append("target_language",t.target_language),a.send(n)},this)},uploadProgress:function(t,e){var i=t.lengthComputable?Math.round(100*t.loaded/t.total):0;$tempFile=this.$(".file-list .files .temporary-file[data-file-cid="+e.cid+"]"),$tempFile.find(".status span").text(i+"%"),100===i&&($tempFile.find(".status span").text("正在处理"),$tempFile.find(".status button").hide())},uploadCompleted:function(t,i,s){var n=t.target;s.remove();try{var a=$.parseJSON(t.target.responseText)}catch(t){var a={}}if(200!==n.status||!a.status_short){this.ls().files.remove(i);var l=a.status_detail?a.status_detail:"未知错误";return void e.push("上传时发生问题："+l+"。","warning")}i.set(a),this.renderInsertFiles(s.render("file")),s.setElement(this.$(".file-list .files li.file[data-file-id="+i.id+"]")),e.push("文件上传成功。","success")},uploadFailed:function(t,i,s){s.remove(),this.ls().files.remove(i),e.push("文件上传失败。","warning")},uploadEnd:function(){this.$(".upload-files .select-button").val(null)},renderInsertFiles:function(t){this.$(".file-list .files").prepend(t),this.trigger("refreshFileTips")},showCreateSetDialog:function(t){t&&t.preventDefault(),this.workTableTop.trigger("showCreateSetDialog")},requestingSetCollection:!1,requestSetCollection:function(t){t.preventDefault(),this.requestingSetCollection||this.refreshSetCollection(!0)},refreshSetCollection:function(t){this.requestingSetCollection=!0,this.workTableTop.main.loading("加载集");var i=function(t){this.$setList.empty(),t.each(function(t){var e=new v({model:t,fm:this});this.renderSetList(e.render()),e.setElement(this.$setList.find(".set[data-set-id="+t.id+"]"))},this),this.workTableTop.main.hideLoading(),this.requestingSetCollection=!1};return t?void this.setCollection.fetch({success:function(t){i.call(this,t)},error:function(){e.push("加载文件集列表出现错误，请重试。","warning"),this.workTableTop.main.hideLoading(),this.requestingSetCollection=!1},context:this}):void i.call(this,this.setCollection)},renderSetList:function(t){this.$setList.append(t)}}),A=t.View.extend({el:".worktable .top",events:{"click .tools .toolkit .tool-global .subtools .message":"attachMessageDialogView","click .tools .toolkit .tool-global .subtools .subtool .logout":"logout","click .tools .toolkit .tool-translate .subtools .refresh-line":"refreshLine","click .tools .toolkit .tool-translate .subtools .goto-line":"gotoLine","blur .current-file":"changeFileName","click .tools .toolkit .tool .toggle":"showDropdown"},initialize:function(){this.messageDialogView=new s,this.$noSetsDialog=$(".no-sets-dialog"),this.sb=new L({wtt:this}),this.fm=new R({wtt:this}),this.gm=new D({wtt:this}),this.cm=new F({wtt:this}),$(window).on("beforeunload",function(){return"关闭工作台？"}),this.on("createSet",this.createSet),this.on("uploadFiles",this.fm.uploadFiles,this.fm),this.createSetDialog=new b({wtt:this}),this.fileLanguageSettingsDialog=new T({wtt:this}),this.beforeSwitchFileDialog=new k({wtt:this}),this.gotoLineDialog=new x({wtt:this}),this.downloadDialog=new C({wtt:this}),this.deleteFileDialog=new S({wtt:this}),this.on("showCreateSetDialog",function(){this.createSetDialog.$el.removeClass("hidden")},this),this.on("showLanguageSettingsDialog",function(t){this.fileLanguageSettingsDialog.showDialog(t)}),_s["WORKTABLE.no_sets"]&&this.noSets(),_s["WORKTABLE.has_reset"]&&this.hasReset(),_s["WORKTABLE.no_files"]&&this.noFiles(),$(window).on("resize",function(){var t=this;return function(){t.windowResize()}}.call(this))},windowResize:function(){this.fm.listResize($(window).innerHeight())},noSets:function(){this.createSetDialog.noSets(),e.push("你需要创建至少一个文件集来存放待翻译文件。")},hasReset:function(){e.push("由于文件（集）的变动，这可能不是你上次工作的位置。")},noFiles:function(){e.push("你当前打开的工作集中没有文件，点击文件管理器的上传按钮上传文件。")},createSet:function(t){this.fm.setCollection.add(t),this.fm.refreshSetCollection(!1)},attachMessageDialogView:function(t){$(t.target).find("i.red-point").addClass("hidden"),this.messageDialogView.displayConversationsDialog(t)},logout:function(t){t&&t.preventDefault(),$.ajax(_s["SYS_CFG.site_url"]+"user/logout/",{method:"POST",data:{token:_s["APP.token"]},dataType:"json",success:function(t){t&&"logout_successful"===t.status_short&&(location.href=_s["SYS_CFG.site_url"]+"start/")}})},refreshLine:function(t){this.main.refreshLineOfCurrentFile(t)},gotoLine:function(t){this.gotoLineDialog.show(t)},displaySidebar:!1,toggleSidebar:function(t){var e=t,i="hide-sidebar-main",s="show-sidebar-main";this.displaySidebar?e.removeClass(s)&&e.addClass(i):e.removeClass(i)&&e.addClass(s),this.displaySidebar=!this.displaySidebar},setMain:function(t){this.main=t,this.listenTo(t,"changeTitle",function(t){this.$(".nav .current-file").val(t)}),this.listenTo(t,"changeLanguage",function(t,e){var i=this.$(".file-language");i.find(".original-language").text(t),i.find(".target-language").text(e)})},openFile:function(t){this.main.open(t)},changeFileName:function(t){var i=$(t.target),s=i.val(),n=this.fm.lf();if(n)return s.match(/[\\\/:?<>"|]/)?e.push("文件名不能包含某些特殊字符。","warning"):void(n.get("name")!==s&&n.set({name:s}).save(null,{success:function(t,i,s){this.main.trigger("resetTitle",n.get("name"),this.fm.ls().get("name")),e.push("文件名修改成功。","success"),this.fm.trigger("reRenderFile",n)},error:function(){e.push("文件名修改失败。","warning")},context:this}))},_closeAllDropdownList:function(){this.$(".subtools").hide(),this.$(".tool .toggle .down-arrow").removeClass("down-arrow-on")},showDropdown:function(t){t&&t.preventDefault(),t.stopPropagation();var e=this._closeAllDropdownList;e(),$target=1===$(t.target).parents("a.toggle").length?$(t.target).parents("a.toggle"):$(t.target),$target.find(".down-arrow").addClass("down-arrow-on"),$target.find("i.red-point").addClass("hidden"),$target.siblings(".subtools").show(),$("body").one("click",function(){var t=this;return function(i){return e.call(t),!0}}.call(this))}}),y=t.View.extend({el:".worktable .wt-main",events:{"keydown .page .row .translated-text .re-worktable-textarea":"textareaKeyDown","click .page .row .para-tools .insert-machine-translation":"clickToInsertMachineTranslation","blur .page .row .translated-text .re-worktable-textarea":"autoSave","click .save":"saveNow","click .page .load-after":"loadAfterRows","click .page .load-before":"loadBeforeRows","click .para-tools .pre-row":"prevRow","click .para-tools .next-row":"nextRow","click .best-translation .show-candidates":"toggleCandidates","click .use-original-text":"useOriginalText","click .best-translation .revoke":"revokeBestTranslation","click .candidate-translations .translation .best":"setAsBestTranslation","click .candidate-translations .translation .delete":"deleteTranslation"},initialize:function(t){this.workTableTop=t.wtt,this.fm=this.workTableTop.fm,i(this.$(".page .row .translated-text .re-worktable-textarea")),this.$loading=this.$(".wt-nav-loading"),this.$noRow=this.$(".page .no-row"),this.unsavedChanges=new o({wtm:this}),this.$loadBefore=this.$(".page .load-before"),this.$loadAfter=this.$(".page .load-after"),this.savingChanges=new o,this.changesBuffer=new o,this.on("checkPreviousLine",function(){!this.fm.lf()||this.fm.lf().lines.get(1)&&this.$(".page .row[data-line=1]").length?this.$loadBefore.addClass("hidden"):this.$loadBefore.removeClass("hidden")},this),this.on("checkNextLine",function(){if(!this.fm.lf())return this.$loadAfter.addClass("hidden");var t=this.fm.lf().lines,e=this.fm.lf().get("line");t.get(e)&&this.$(".page .row[data-line="+e+"]").length?this.$loadAfter.addClass("hidden"):this.$loadAfter.removeClass("hidden")},this),this.on("checkLine",function(){this.$(".page .row").length?this.$(".no-row").addClass("hidden").text("正在加载行···"):this.$(".no-row").removeClass("hidden").text("文件可能加载失败或没有行。")},this),this.on("textareaUpdate",function(){i(this.$(".page .row .translated-text .re-worktable-textarea"))},this),this.on("resetTitle",function(t,e){var i=$("html head title");defaultTitle=_s["WORKTABLE.default_title"]+" / ResTrans",e&&(defaultTitle=e+" / "+defaultTitle),t&&(defaultTitle=t+" / "+defaultTitle),i.text(defaultTitle)},this),this.listenTo(this.changesBuffer,"remove",function(t,e){this.saving||!this.countdown||e.size()||(window.clearTimeout(this.countdown),this.countdown=!1,this.$(".save").addClass("hidden"))}),this.listenTo(t.wtt.beforeSwitchFileDialog,"save",function(e){this.saveChanges(function(){var i=t.wtt.beforeSwitchFileDialog;i.hide(e),this.open(i.file),i.file=void 0},this)}),this.listenTo(t.wtt.beforeSwitchFileDialog,"discard",function(i){this.savingChanges.reset(),this.changesBuffer.reset(),this.$(".save").addClass("hidden"),this.saving=!1,window.clearTimeout(this.countdown),this.countdown=void 0;var s=t.wtt.beforeSwitchFileDialog;console.log(s),s.hide(i),this.open(s.file),s.file=void 0,e.push("变更已全部抛弃。")}),this.listenTo(t.wtt.gotoLineDialog,"gotoLine",this.gotoLine),_s["WORKTABLE.no_files"]&&this.noFiles(),_s["WORKTABLE.last_file_lines"]&&this.initLines(_s["WORKTABLE.last_file_lines"]),this.trigger("checkLine"),t.wtt.windowResize(),this.hideLoading()},prevRow:function(t){var e=$(t.target).parents(".row").find(".re-worktable-textarea");this.selectPrevTextArea({target:e}),t.preventDefault()},nextRow:function(t){var e=$(t.target).parents(".row").find(".re-worktable-textarea");this.selectNextTextArea({target:e}),t.preventDefault()},toggleCandidates:function(t){var e=$(t.target);$candidates=e.parents(".row").find("ul.candidate-translations"),$candidates.hasClass("hidden")?(e.text("收起候选译文"),$candidates.removeClass("hidden")):(e.text("展开候选译文"),$candidates.addClass("hidden")),t.preventDefault()},useOriginalText:function(t){var e=$(t.target),i=e.parents(".row").find(".translated-text .re-worktable-textarea"),s=this.fm.lf().lines.get(e.parents(".row").data("line"));i.val(s.get("text")),t.preventDefault()},textareaKeyDown:function(t){(t.ctrlKey||t.shiftKey)&&(39===t.keyCode&&this.insertMachineTranslation(t),(40===t.keyCode||9===t.keyCode)&&this.selectNextTextArea(t),38===t.keyCode&&this.selectPrevTextArea(t))},clickToInsertMachineTranslation:function(t){return t&&t.preventDefault(),console.log($(t.target).parents(".para-tools").siblings(".translated-text").find("textarea")),this.insertMachineTranslation($(t.target).parents(".para-tools").siblings(".translated-text").find("textarea"))},selectNextTextArea:function(t){$(t.target).parents(".row").nextAll(".row").has(".re-worktable-textarea").first().find(".re-worktable-textarea").focus()},selectPrevTextArea:function(t){$(t.target).parents(".row").prevAll(".row").has(".re-worktable-textarea").first().find(".re-worktable-textarea").focus()},insertMachineTranslation:function(t){var e=t[0]?t:$(t.target),i=this.fm.lf().lines.get(e.parents(".row").data("line"));e.val()||e.val(i.get("machine_translation"))},initLines:function(t){var e=this.fm.lf().lines;e.reset(t),this.clearLines().renderInsertLines(e)},noFiles:function(){this.$noRow.removeClass("hidden").text("没有文件，在文件管理器中打开或上传文件。")},interval:null,loading:function(t){this.$loading.find(".loading-text").text(t),this.interval=window.setInterval(function(){var t=this,e=1,i={1:"·  ",2:" · ",3:"  ·"};return function(){e++&&4===e&&(e=1),t.$loading.find(".ing").text(" "+i[e])}}.call(this),1e3),this.$loading.show()},hideLoading:function(){this.$loading.hide(),window.clearInterval(this.interval),this.$loading.find(".loading-text").val("正在加载")},clearLines:function(){return this.$(".page .row").remove(),this.trigger("checkPreviousLine"),this.trigger("checkNextLine"),this.trigger("checkLine"),this},open:function(t){var e=t.collection.fileSet,i=t.lines,s=function(){this.fm.ls(e),this.fm.lf(t),this.clearLines().renderInsertLines(i),this.hideLoading(),this.trigger("resetTitle",t.get("name"),e.get("name")),this.trigger("changeTitle",t.get("name")),this.trigger("changeLanguage",t.get("original_language_name"),t.get("target_language_name"))};if(!this.lock()){if(this.changesBuffer.size()||this.saving){var n=this.workTableTop.beforeSwitchFileDialog;return n.file=t,n.show()}if(this.loading("正在打开文件"),i.size())return s.call(this);i.setUrl(),this.loadRows(i,1,100,s,!0)}},renderInsertLines:function(t){t.each(function(e){if(!this.$(".page .row[data-line="+e.id+"]").length){var i=new c({model:e});if(!this.$(".page .row").length)return this.$(".page .load-before").after(i.render());var s=_.indexOf(t.models,e),n=t.models[s-1],a=t.models[s+1],l=n?this.$(".page .row[data-line="+n.id+"]"):{},o=a?this.$(".page .row[data-line="+a.id+"]"):{};l.length?l.after(i.render()):o.length?o.before(i.render()):e.id<this.$(".page .row:first").data("line")?this.$(".page .row:first").before(i.render()):this.$(".page .row").each(function(){e.id<$(this).data("line")&&$(this).before(i.render())})}},this),this.trigger("textareaUpdate"),this.trigger("checkPreviousLine"),this.trigger("checkNextLine"),this.trigger("checkLine")},autoSave:function(t){var e,i=$(t.target),s=i.val(),n=this.fm.lf().lines.get(i.parents(".row").data("line")),a=n.translations;if(e=a.myTranslation()){if(e.get("text")===s)return;e.set({text:s,friendly_time:"不久之前"})}else{if(!s)return;e=a.add({file_id:this.fm.lf().id,line:n.id,text:s,best_translation:0,contributor:_s["USER.user_id"],contributor_name:_s["USER.user_name"],friendly_time:"不久之前"}),e.set({_cid:e.cid})}this.autoSaveChanges(e)},saveNow:function(t){t.preventDefault(),this.saveChanges()},countdown:void 0,saving:!1,autoSaveChanges:function(t){this.updateTranslation(t),this.changesBuffer.add(t,{merge:!0}),this.saving||this.countdown||(this.$(".save").removeClass("hidden"),this.startCountdown())},startCountdown:function(){this.countdown=window.setTimeout(function(){var t=this;return function(){t.saveChanges()}}.call(this),12e4)},saveChanges:function(t,i){if(!this.saving&&this.changesBuffer.size()){this.$(".save").addClass("hidden"),this.saving=!0,window.clearTimeout(this.countdown),this.countdown=void 0,this.savingChanges.reset(this.changesBuffer.models),this.changesBuffer.reset(),this.loading("正在保存"),
this.savingChanges.setUrl(this.fm.lf().collection.fileSet.id,this.fm.lf().id);var s=function(){this.saving=!1,this.hideLoading()};this.savingChanges.sync("patch",this.savingChanges,{context:this,success:function(n,a,l){return s.call(this),"part_patched"===n.status_short||"all_patched"===n.status_short?("part_patched"===n.status_short&&e.push("修改已提交，但只有部分被保存，将在稍后重试。","success"),"all_patched"===n.status_short&&e.push("您的修改已保存。","success"),this.afterSaved(n.patched,this.savingChanges,t,i)):void e.push("保存失败，将在稍后重试。","warning")},error:function(t,i,n){s.call(this),e.push("保存失败："+t.responseJSON.status_detail,"warning"),this.savingChanges.each(function(t){this.autoSaveChanges(t)},this)}})}},afterSaved:function(t,e,i,s){_.each(t,function(t){var i=e.get(t.translation_id)?e.get(t.translation_id):e.findWhere({_cid:t._cid});if(i){var s=i.id?i.id:t._cid,n=this.fm.lf().lines.get(t.line).translations,a=this.$(".row[data-line="+t.line+"]").find(".candidate-translations").find(".translation[data-translation-id='"+s+"']");a.attr("data-translation-id",t.translation_id),n.bestTranslation||a.find(".panel .options .best").removeClass("hidden"),t._cid=void 0,t.text?n.get(s).set(t):n.remove(i),e.remove(i)}},this),e.each(this.autoSaveChanges,this),0===this.changesBuffer.size()&&i&&s&&i.call(s),e.reset()},updateTranslation:function(t){var e=this.$(".page .row[data-line="+t.get("line")+"]"),i=t.id?t.id:t.cid,s=e.find("li.translation[data-translation-id="+i+"]"),n=e.find(".best-translation[data-best-translation-id="+i+"]"),a=e.find(".candidate-translations");if(!t.get("text"))return n.length&&n.remove()&&a.removeClass("hidden"),s.length&&s.remove();if(!s.length){var l=new r({model:t});return e.find(".candidate-translations").prepend(l.render())}s.find("p").text(t.get("text")),n&&n.find("p").text(t.get("text")),s.find(".panel .meta .date").text(t.get("friendly_time"))},revokeBestTranslation:function(t){var i=$(t.target),s=this.fm.lf().lines.get(i.parents(".row").data("line")),n=i.parents(".best-translation"),a=s.translations.get(n.data("best-translation-id"));if(i.data("disabled")!==!1)return!1;this.loading("正在撤销最佳译文"),i.data("disabled",!0);var l=function(){i.data("disabled",!1),this.hideLoading()};a.set({best_translation:!1}),a.setUrlRoot(),a.save(null,{context:this,success:function(t,s){return l.call(this),"translation_update_succeed"!==s.status_short?e.push("撤销时发生错误。","warning"):($parents=i.parents(".best-translation"),$parents.addClass("hidden"),void $parents.siblings(".candidate-translations").removeClass("hidden").find(".translation .best").removeClass("hidden").siblings(".translation .delete").removeClass("hidden"))},error:function(t,i){return l.call(this),(status_detail=i.responseJSON.status_detail)?e.push("撤销时发生错误。"+status_detail,"warning"):void 0}}),t.preventDefault()},setAsBestTranslation:function(t){var i=$(t.target),s=this.fm.lf().lines.get(i.parents(".row").data("line")),n=i.parents(".translation"),a=s.translations.get(n.data("translation-id"));if(i.data("disabled")!==!1)return!1;this.loading("正在设为最佳译文"),i.data("disabled",!0);var l=function(){i.data("disabled",!1),this.hideLoading()};a.set({best_translation:!0,proofreader:_s["USER.user_id"],proofreader_name:_s["USER.user_name"]}),a.setUrlRoot(),a.save(null,{context:this,success:function(t,n){if(l.call(this),"translation_update_succeed"!==n.status_short)return e.push("设为最佳时发生错误。","warning");$parents=i.parents(".candidate-translations"),$parents.find(".translation .best").addClass("hidden"),$parents.find(".translation[data-translation-id="+t.id+"] .delete").addClass("hidden"),s.translations.bestTranslation=a;var o=new c({model:s});$parents.siblings(".best-translation").remove(),$parents.before(o.renderBestTranslation()),$parents.addClass("hidden")},error:function(t,i){return l.call(this),(status_detail=i.responseJSON.status_detail)?e.push("设为最佳时发生错误："+status_detail,"warning"):void 0}}),t.preventDefault()},deleteTranslation:function(t){t.preventDefault();var i=$(t.target),s=this.fm.lf().lines.get(i.parents(".row").data("line")),n=i.parents(".translation"),a=n.data("translation-id"),l=s.translations.get(a),o=this.changesBuffer.get(a);return this.changesBuffer.remove(o),o&&o.isNew()&&n.remove(),l&&l.isNew()?s.translations.remove(l):(l.setUrlRoot(),void l.destroy({success:function(){n.remove()},error:function(){e.push("删除一个候选译文时失败。","warning")},context:this}))},isLocked:!1,lock:function(t){return void 0===t?this.isLocked:void(this.isLocked=Boolean(t))},loadBeforeRows:function(t){if(t.preventDefault(),!this.lock()){var e=$(t.target),i=(this.fm.lf(),function(t){return t.fm.lf().lines}),s=this.$(".page .row:first"),n=function(){this.lock(!1),this.fm.lf()===i(this).fileModel&&(this.renderInsertLines(i(this)),this.hideLoading(),e.find("a").text("加载之前的行"))};this.loading("正在加载行"),this.lock(!0),e.find("a").text("加载之前的行···"),i(this).first().get("line_number")!==s.data("line")&&this.renderInsertLines(i(this));var a=s.data("line")-100<=1?1:s.data("line")-100,l=s.data("line");this.loadRows(i(this),a,l,n,!1,!1)}},loadAfterRows:function(t){if(t.preventDefault(),!this.lock()){var e=$(t.target),i=this.fm.lf(),s=function(t){return t.fm.lf().lines},n=this.$(".page .row:last"),a=function(){this.lock(!1),this.fm.lf()===s(this).fileModel&&(this.renderInsertLines(s(this)),this.hideLoading(),e.find("a").text("加载之后的行"))};this.loading("正在加载行"),this.lock(!0),e.find("a").text("加载之后的行···"),s(this).first().get("line_number")!==n.data("line")&&this.renderInsertLines(s(this));var l=n.data("line")+1,o=n.data("line")+100>i.get("line")?i.get("line"):n.data("line")+100;this.loadRows(s(this),l,o,a,!1,!1)}},refreshLineOfCurrentFile:function(t){if(t.preventDefault(),!this.lock()){var e=this.fm.lf(),i=function(t){return t.fm.lf().lines},s=function(){this.lock(!1),this.fm.lf()===i(this).fileModel&&(this.clearLines().renderInsertLines(i(this)),this.hideLoading())};e&&(this.loading("正在加载行"),this.lock(!0),this.loadRows(i(this),i(this).first().get("line_number"),i(this).last().get("line_number"),s,!0))}},gotoLine:function(t){var e=this.$(".row[data-line="+t+"]"),i=function(t){t.workTableTop.gotoLineDialog.trigger("close")};if(e.length)return $("body").animate({scrollTop:e.offset().top-35},500),i(this);if(!this.lock()){this.lock(!0);var s=this.fm.lf(),n=function(t){return t.fm.lf().lines},a=function(){this.lock(!1),this.fm.lf()===n(this).fileModel&&(this.clearLines().renderInsertLines(n(this)),this.hideLoading())};if(s)return this.loading("正在加载行"),this.loadRows(n(this),t,100,a,!0),i(this)}},loadRows:function(t,i,s,n,a,l){t.fetch({data:{start:i,end:s},context:this,remove:l,reset:a,success:function(t,i,s){return i.status_detail?e.push("加载行时发生错误。","warning"):void(n&&n.call(this))},error:function(t,i,s){return this.hideLoading(),i.responseJSON.status_detail?e.push("加载文件发生错误。","warning"):void 0}})}}),B=new A,O=new y({wtt:B});B.setMain(O)});