define(["backbone","notifications","message"],function(t,i,e){var n=t.Model.extend({idAttribute:"hash"}),o=t.View.extend({events:{"click .open":"open","click .delete":"delete"},open:function(t){t&&t.preventDefault(),this.$("button").attr("disabled",!0),$(t.target).text("准备工作台···"),location.href=_s["SYS_CFG.site_url"]+"worktable/"+this.model.get("hash")},"delete":function(t){t&&t.preventDefault(),this.$("button").attr("disabled",!0),$(t.target).text("删除记录···"),this.model.destroy({success:function(i,e){e&&"record_deleted"===e.status_short&&($(t.target).text("记录已删除"),this.$el.css("opacity",".5"))},error:function(e,n){this.$("button").removeAttr("disabled"),$(t.target).text("删除"),_s.reqErrorHandle(n,"删除工作台记录失败：",null,!0,"warning",i)},context:this})},template:_.template($("#template-draft").html()),render:function(){return this.template(this.model.attributes)}}),a=t.Collection.extend({model:n,url:_s["SYS_CFG.site_uri"]+"draft/",fetched:!1,fetching:!1}),s=t.View.extend({el:".dropdown-workingset",initialize:function(){this.collection=new a,this.listenTo(this.collection,"sync",this.render)},show:function(t){t&&t.preventDefault(),this.collection.fetched||this.collection.fetching||(this.$(".load-drafts").removeClass("hidden"),this.collection.fetch({error:function(t){this.collection.fetching=!1,this.collection.fetched=!0,this.$(".load-drafts").addClass("hidden"),this.$(".no-drafts").removeClass("hidden")},context:this}))},render:function(t){t.fetching=!1,t.fetched=!0,this.$(".load-drafts").addClass("hidden"),t.size()||(this.$(".load-drafts").addClass("hidden"),this.$(".no-drafts").removeClass("hidden"));var i=this.$(".draft-list");t.each(function(t){if(!i.find("li.draft[data-draft-hash="+t.id+"]").length){var e=new o({model:t});i.append(e.render()),e.setElement(i.find("li.draft[data-draft-hash="+t.id+"]"))}},this)}}),r=t.Model.extend({idAttribute:"notification_id",url:_s["SYS_CFG.site_uri"]+"notification/organization/"}),c=t.Model.extend({idAttribute:"notification_id"}),l=t.View.extend({events:{"click .operation-organization-accept":"orgAccept","click .operation-ignore":"orgIgnore","click .operation-reject":"orgReject","click .operation-delete":"destroyNotification"},initialize:function(){this.orgCtl=new r({notification_id:this.model.id,new_status:this.model.get("status")})},orgAccept:function(t){t&&t.preventDefault(),this._snCtl(this.orgCtl,2,this._organizationNotificationUpdateSucceed)},orgReject:function(t){t&&t.preventDefault(),this._snCtl(this.orgCtl,3,this._organizationNotificationUpdateSucceed)},orgIgnore:function(t){t&&t.preventDefault(),this._snCtl(this.orgCtl,4,this._organizationNotificationUpdateSucceed)},_organizationNotificationUpdateSucceed:function(t,i){if(i&&"notification_updated"===i.status_short){this.$("button").removeAttr("disabled"),this.$("button").remove();var e=t.get("new_status"),n="已同意";n=3===e?"已拒绝":n,n=4===e?"已忽略":n;var o='<span class="operation-status">'+n+"</span> ";o+='<button class="re-button re-button-xs operation-delete">清除此条</button>',this.$(".actions").append(o)}},_snCtl:function(t,i,e){this.$("button").attr("disabled",!0),t.save({new_status:i},{success:e,merge:!0,context:this})},destroyNotification:function(t){t&&t.preventDefault(),this.$("button").attr("disabled",!0);var e=this.orgCtl.url;this.orgCtl.url=e+this.orgCtl.id,this.orgCtl.destroy({success:function(){this.$("button").text("提醒已清除"),this.$el.css("opacity",".5")},error:function(t,e){_s.reqErrorHandle(e,"清除提醒失败：",null,!0,"warning",i)},context:this}),this.orgCtl.url=e},template:_.template($("#template-sys-notification").html()),render:function(){return this.template(this.model.attributes)}}),d=t.Collection.extend({model:c,url:_s["SYS_CFG.site_uri"]+"notification/organization/",fetched:!1}),h=t.View.extend({el:".dropdown-notifications",events:{"click .load-notifications":"loadNotifications"},initialize:function(){this.collection=new d,this.listenTo(this.collection,"sync",this.render)},fetching:!1,show:function(t){t&&t.preventDefault(),this.collection.fetched||this.fetching||(this.fetching=!0,this.collection.fetch({data:{start:1},error:function(){this.fetching=!1}}))},loadNotifications:function(t){t&&t.preventDefault(),this.fetching||(this.$(".load-notifications").text("正在加载提醒···"),this.fetching=!0,this.collection.fetch({data:{start:this.sum+20},error:function(){this.fetching=!1}}))},sum:0,render:function(t,i){this.collection.fetched=!0,this.fetching=!1,this.collection.size()<20||i.length<20?(this.$(".load-notifications").addClass("hidden"),this.$(".no-notifications").removeClass("hidden")):this.$(".load-notifications").text("加载更多提醒"),this.collection.each(function(t){var i=".notification[data-sys-notification-id="+t.id+"]";if(!this.$(i).length){var e=new l({model:t});this.$(".system-notifications").append(e.render()),e.setElement(this.$(i)),this.sum++}},this)}}),u=t.View.extend({el:".nav-bar",events:{"click a#create-task":"showCreateTaskDialog","click a#create-organization":"showCreateOrganizationDialog","click #show-message":"attachMessageDialogView","click #logout":"logout","click .dropdown>a":"showDropdown","click .dropdown-container a":"showDropdownContainer"},initialize:function(t){this.messageDialogView=new e,this.createDialogView=t.createDialogView,this.WorkingSetsView=new s,this.systemOrganizationNotifications=new h},attachMessageDialogView:function(t){$(t.target).find("i.red-point").addClass("hidden"),this.messageDialogView.displayConversationsDialog(t)},showCreateTaskDialog:function(t){t.preventDefault(),this.createDialogView.displayCreateDialog("Task")},showCreateOrganizationDialog:function(t){t.preventDefault(),this.createDialogView.displayCreateDialog("Organization")},hideCreateDialog:function(t){t.preventDefault(),this._resetCreateDiagStyle()},_closeAllDropdownContainer:function(){this.$(".container-inner").hide(),this.$(".dropdown-container a i.down-arrow").removeClass("down-arrow-on")},_closeAllDropdownList:function(){this.$(".dropdown-list").hide(),this.$(".dropdown a i.down-arrow").removeClass("down-arrow-on")},showDropdown:function(t){t&&t.preventDefault(),t.stopPropagation();var i=this._closeAllDropdownList;i(),this._closeAllDropdownContainer(),$target=$(t.target),$parents=$target.parents(".dropdown"),$parents.find("i.down-arrow").addClass("down-arrow-on"),$parents.children("a").find(".red-point").addClass("hidden"),$parents.find(".dropdown-list").show(),$("body").one("click",function(){var t=this;return function(){i.call(t)}}.call(this))},_show:function(t){t[0]===this.$(".dropdown-notifications")[0]?this.systemOrganizationNotifications.show(void 0):t[0]===this.$(".dropdown-workingset")[0]&&this.WorkingSetsView.show(void 0)},showDropdownContainer:function(t){var i=this._closeAllDropdownContainer;i(),this._closeAllDropdownList(),t.stopPropagation(),$target=$(t.target),$container=$target.parents(".dropdown-container"),$container.find("i.down-arrow").addClass("down-arrow-on"),$containerInner=$container.find(".container-inner"),$containerInner.show(),this._show($container),$("body").on("click",function(t){return $.contains($containerInner[0],t.target)?!1:void i()})},logout:function(t){t&&t.preventDefault(),$.ajax(_s["SYS_CFG.site_url"]+"user/logout/",{method:"POST",data:{token:_s["APP.token"]},dataType:"json",success:function(t){t&&"logout_successful"===t.status_short&&location.reload()}})}}),g=t.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"organization",validate:function(t,i){return""===$.trim(t.name)?"data_error":void 0}}),f=t.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"task",validate:function(t,i){return""===t.organization_id||""===$.trim(t.name)?"data_error":void 0}}),p=t.View.extend({el:"#create-diag",events:{"click #create-organization-action":"createOrganization","click #create-task-action":"createTask","click .list-item a":"setCurrentOrganization","click #close-diag":"closeCreateDialog","click #create-diag-navtsk>a":"displayCreateTaskDialog","click #create-diag-navorg>a":"displayCreateOrganizationDialog","click .current-organization .undo":"undoCurrentOrganization"},initialize:function(t){this.organizationModel=t.organizationModel,this.taskModel=t.taskModel,this.$organizationName=this.$("#organization-name"),this.$organizationDescription=this.$("#organization-description"),this.$createOrganizationAction=$("#create-organization-action"),this.$createTaskAction=$("#create-task-action"),this.$taskBelong=this.$("#task-organization"),this.$taskName=this.$("#task-name"),this.$taskDescription=this.$("#task-description"),this.$searchOrganizationDropdownList=this.$(".dropdown-select-list")},_titleSwitch:function(t){var i={task:"#create-diag-navtsk",organization:"#create-diag-navorg"};_.forIn(i,function(i,e){t===e?$(i).addClass("active"):$(i).removeClass("active")})},_formSwitch:function(t){var i={task:"#create-task-form",organization:"#create-organization-form"},e={task:"#create-task-action",organization:"#create-organization-action"};_.forIn(i,function(i,n){t===n?function(){$(i).css("display","block"),$(e[n]).css("display","inline-block")}():function(){$(i).css("display","none"),$(e[n]).css("display","none")}()})},displayCreateTaskDialog:function(t){t.preventDefault(),this.displayCreateDialog("Task")},displayCreateOrganizationDialog:function(t){t.preventDefault(),this.displayCreateDialog("Organization")},displayCreateDialog:function(t){return this["_displayCreate"+t+"Dialog"]()},_displayCreateTaskDialog:function(){this.$el.css("display","table"),this._formSwitch("task"),this._titleSwitch("task")},_displayCreateOrganizationDialog:function(){this.$el.css("display","table"),this._formSwitch("organization"),this._titleSwitch("organization")},closeCreateDialog:function(t){this.$el.css("display","none")},createOrganization:function(t){this.$createOrganizationAction.attr("disabled",""),this.$createOrganizationAction.text("正在创建…"),this.organizationModel.clear(),this.organizationModel.set({name:this.$organizationName.val(),description:this.$organizationDescription.val(),token:_s["APP.token"]}),this.listenToOnce(this.organizationModel,"invalid",function(){"data_error"===this.organizationModel.validationError&&(i.push("创建组织的必要字段必须填写完整。","warning"),this.$createOrganizationAction.removeAttr("disabled"),this.$createOrganizationAction.text("创建组织"))});var e=function(t,i){"create_organization_succeed"===i.status_short&&_.has(i,"url")&&(window.location.href=i.url)},n=function(t,e){var n=e.responseJSON;_.has(n,"status_detail")&&i.push(n.status_detail,"warning"),_.has(n,"token")&&""!==n.token&&(this.organizationModel.set({token:n.token}),_s["APP.token"]=n.token),this.$createOrganizationAction.removeAttr("disabled"),this.$createOrganizationAction.text("创建组织")};this.organizationModel.save(null,{success:e,error:n,context:this}),t.preventDefault()},createTask:function(t){var e=function(){this.$createTaskAction.removeAttr("disabled"),this.$createTaskAction.text("创建任务")};this.$createTaskAction.attr("disabled",""),this.$createTaskAction.text("正在创建···"),this.taskModel.clear(),this.taskModel.set({organization_id:this.$taskBelong.val(),name:this.$taskName.val(),description:this.$taskDescription.val(),token:_s["APP.token"]},{validate:!0}),"data_error"===this.taskModel.validationError&&(i.push("创建任务的必要字段必须填写完整。","warning"),e.call(this));var n=function(t,i){"create_task_succeed"===i.status_short&&_.has(i,"url")&&(window.location.href=i.url)},o=function(t,n){var o=n.responseJSON;_.has(o,"status_detail")&&i.push(o.status_detail,"warning"),_.has(o,"token")&&""!==o.token&&(this.taskModel.set({token:o.token}),_s["APP.token"]=o.token),e.call(this)};this.taskModel.save(null,{success:n,error:o,context:this})}}),w=new p({organizationModel:new g,taskModel:new f});new u({createDialogView:w})});