define(["backbone","notifications"],function(e,t){var i=e.Model.extend({idAttribute:"task_id",url:function(){return _s["SYS_CFG.site_uri"]+"task/"+this.id+"/setting/api/key/"}}),s=e.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"task/"+_s["TASK.task_id"]+"/setting/"}),n=e.Model.extend({urlRoot:_s["SYS_CFG.site_uri"]+"worktable/"}),a=e.Model.extend({idAttribute:"set_id",urlRoot:_s["SYS_CFG.site_uri"]+"task/"+_s["TASK.task_id"]+"/set/",validate:function(e){return!$.trim(e.name)}}),r=e.Collection.extend({model:a}),l=e.View.extend({el:".create-set-dialog",events:{"click .close-dialog":"hideDialog","submit .create-set":"createSet"},showDialog:function(e){e.preventDefault(),this.$el.show()},hideDialog:function(e){this.$el.hide()},createSet:function(e){e.preventDefault();var i=$(e.target),s=i.find(".set-name"),n=i.find("button[type=submit]"),a=function(){n.removeAttr("disabled"),n.text("创建集")};n.attr("disabled",""),n.text("创建集…"),this.model.set({name:s.val(),token:_s["APP.token"]},{validate:!0}),this.model.validationError&&t.push("请输入文件集的名称。","warning");var r=function(e,t){n.text("正在完成···"),"create_set_succeed"===t.status_short&&_.has(t,"url")&&(window.location.href=t.url)},l=function(e,i){var s=i.responseJSON;this.model.set({token:_s["APP.token"]=s.token}),_.has(s,"status_detail")&&t.push(s.status_detail,"warning"),a.call(this)};this.model.save(null,{success:r,error:l,context:this})}}),o=e.View.extend({el:".delete-set-dialog",events:{"click .delete":"delete","click .close":"hide"},set:void 0,"delete":function(e){e&&e.preventDefault();var i=$(e.target);return i.attr("disabled",!0),this.set?void this.set.destroy({context:this,success:function(e,t){return t&&"set_deleted"===t.status_short&&t.redirect_url?(location.href=t.redirect_url,i.text("正在完成···")):void i.removeAttr("disabled")},error:function(e,s){_s.reqErrorHandle(s,"删除文件集失败：",null,!0,"warning",t),i.removeAttr("disabled")}}):i.removeAttr("disabled")},show:function(e){e&&e.preventDefault(),this.$el.removeClass("hidden")},hide:function(e){e&&e.preventDefault(),this.$el.addClass("hidden")}}),d=e.View.extend({el:".task-right",events:{"click .secondary-nav .create-set a":"showCreateSetDialog","click .files .open":"open","click .files .delete-set":"deleteSet"},initialize:function(e){this.createSetDialog=new l({model:new a}),this.deleteSetDialog=new o,this.setCollection=new r(_s["TASK.sets"]),_s["TASK.current_set"]&&(this.currentSet=this.setCollection.get(_s["TASK.current_set"].set_id)),this.$openingWorktable=$(".open-worktable")},deleteSet:function(e){this.deleteSetDialog.set=this.currentSet,this.deleteSetDialog.show()},showCreateSetDialog:function(e){this.createSetDialog.showDialog(e)},open:function(e){e&&e.preventDefault(),this.$openingWorktable.removeClass("hidden");var i=new n;i.fetch({data:{organization_id:_s["ORG.organization_id"],task_id:_s["TASK.task_id"],set_id:_s["TASK.current_set"].set_id},context:this,success:function(e,i){console.log(i),i.link?location.href=i.link:(this.$openingWorktable.addClass("hidden"),t.push("打开工作台失败。"))},error:function(e,i){this.$openingWorktable.addClass("hidden"),_s.reqErrorHandle(i,"打开工作台失败：",null,!0,"warning",t)}})}}),c=e.View.extend({el:".delete-task-dialog",events:{"click .delete":"delete","click .cancel":"hide"},initialize:function(t){this.workTableTop=t.wtt,this.task=new(e.Model.extend({idAttribute:"task_id",defaults:{task_id:_s["TASK.task_id"]},urlRoot:_s["SYS_CFG.site_url"]+"task/"}))},"delete":function(e){e&&e.preventDefault(),$target=$(e.target),$target.attr("disabled",!0),this.task.destroy({context:this,success:function(e,t){$target.removeAttr("disabled"),t&&"task_deleted"===t.status_short&&t.redirect_url&&(location.href=t.redirect_url)},error:function(e,i){$target.removeAttr("disabled"),_s.reqErrorHandle(i,"删除失败：",null,!0,"warning",t)}})},hide:function(e){e.preventDefault(),this.$el.addClass("hidden")}}),u=e.View.extend({el:".task-right",events:{"submit .general-setting":"saveSetting","click .delete-task .open-delete-dialog":"openDeleteDialog","click .freeze":"freezeTask","click .api-key .regenerate":"regenerateNewKey"},initialize:function(){this.deleteTaskDialog=new c({sv:this}),this.setting=new s({name:_s["TASK.name"],description:_s["TASK.description"],original_language:_s["TASK.original_language"],target_language:_s["TASK.target_language"]}),this.apiKeySetting=new i({task_id:_s["TASK.task_id"]}),this.listenTo(this.apiKeySetting,"sync",this.renderKey),this.freeze=new(e.Model.extend({idAttribute:"task_id",defaults:{task_id:_s["TASK.task_id"],frozen:_s["TASK.frozen"]},urlRoot:_s["SYS_CFG.site_uri"]+"task/"}))},saveSetting:function(e){e&&e.preventDefault();var i=$(e.target).find("input[type=submit]");i.attr("disabled",!0),this.setting.save({token:_s["APP.token"],name:this.$("#task-name").val(),description:this.$("#task-desc").val(),original_language:this.$("input[name=task-original-language]").filter(":checked").val(),target_language:this.$("input[name=task-target-language]").filter(":checked").val()},{success:function(e,s){i.removeAttr("disabled"),t.push("已保存。","success"),_s["APP.token"]=s.token,$("title").text(e.get("name")+" / 任务选项 / ResTrans"),$(".task-left a.task-name").text(e.get("name")),$(".task-left p.task-description").text(e.get("description"))},error:function(e,s){i.removeAttr("disabled"),_s.reqErrorHandle(s,"保存失败：",null,!0,"warning",t),_s["APP.token"]=s.responseJSON.token}})},regenerateNewKey:function(e){e&&e.preventDefault(),$(e.target).attr("disabled",!0).text("重新生成···"),this.apiKeySetting.save(null,{context:this,remove:!1,add:!1,merge:!1,error:function(e,i){_s.reqErrorHandle(i,"冻结失败：",null,!0,"warning",t)},complete:function(){$(e.target).removeAttr("disabled").text("重新生成")}})},renderKey:function(e,t){t&&"api_key_updated"===t.status_short&&t.api_key&&this.$(".api-key .key").val(t.api_key)},openDeleteDialog:function(e){e&&e.preventDefault(),this.deleteTaskDialog.$el.removeClass("hidden")},freezeTask:function(e){e&&e.preventDefault(),$target=$(e.target),cs=this.freeze.get("frozen"),$target.attr("disabled",!0),cs?$target.text("正在解冻···"):$target.text("正在冻结···"),this.freeze.save({frozen:!cs},{context:this,success:function(e,t){t.hasOwnProperty("frozen")&&(t.frozen?$target.removeClass("re-button-primary").text("解除冻结"):$target.addClass("re-button-primary").text("冻结此任务")),$target.removeAttr("disabled")},error:function(e,i){$target.removeAttr("disabled"),_s.reqErrorHandle(i,"冻结失败：",null,!0,"warning",t)}})}});1===_s["TASK.page_type"]&&new d,2===_s["TASK.page_type"]&&new u});